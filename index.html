<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no" />
<title>Room Expense Tracker -- Dark Elegant</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* Basic Reset and Variables */
:root{
  --bg-1:#0f2027;
  --bg-2:#203a43;
  --bg-3:#2c5364;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.03);
  --accent: #00c6ff;
  --accent-2: #1de9b6;
  --danger: #ff5252;
  --text-light: #e6f7ff;
  --muted: #9fb4bf;
  --card-radius: 14px;
  --glass-blur: 8px;
  font-family: 'Inter', sans-serif;
}

body {
  margin: 0;
  padding: 0;
  background: var(--bg-1);
  color: var(--text-light);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

/* Typography */
h1 {
  background: -webkit-linear-gradient(45deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 10px rgba(0, 198, 255, 0.4);
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

h2 {
  color: var(--accent-2);
  font-size: 1.5rem;
  border-bottom: 2px solid var(--accent);
  padding-bottom: 0.25rem;
  margin-top: 2rem;
  margin-bottom: 1rem;
}

/* Layout */
.container {
  max-width: 1000px;
  width: 95%;
  margin: 20px auto;
  padding: 20px;
  flex-grow: 1;
}

.grid {
  display: grid;
  gap: 20px;
  grid-template-columns: 1fr;
}

@media (min-width: 768px) {
  .grid {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  }
  .grid-2-1 {
    grid-template-columns: 2fr 1fr;
  }
}

/* Card Styling (Glassmorphism) */
.card {
  background: var(--glass);
  backdrop-filter: blur(var(--glass-blur));
  border-radius: var(--card-radius);
  padding: 20px;
  box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  border: 1px solid rgba(255, 255, 255, 0.18);
  transition: all 0.3s ease;
}
.card:hover {
  box-shadow: 0 10px 40px 0 rgba(0, 198, 255, 0.2);
}

/* Buttons */
.btn {
  padding: 10px 15px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  margin-right: 5px;
  margin-bottom: 5px;
  display: inline-flex;
  align-items: center;
}

.btn i {
  margin-right: 8px;
}

.btn-primary {
  background-color: var(--accent);
  color: var(--bg-1);
}
.btn-primary:hover {
  background-color: #0099e5;
  box-shadow: 0 6px 8px rgba(0, 198, 255, 0.3);
}

.btn-secondary {
  background-color: var(--bg-3);
  color: var(--text-light);
  border: 1px solid var(--accent-2);
}
.btn-secondary:hover {
  background-color: var(--bg-2);
}

.btn-danger {
  background-color: var(--danger);
  color: white;
}
.btn-danger:hover {
  background-color: #d84315;
}

/* Inputs */
input[type="text"], input[type="number"], select {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border: 1px solid var(--accent);
  border-radius: 6px;
  background-color: var(--glass-2);
  color: var(--text-light);
  box-sizing: border-box;
}
input[type="number"]::-webkit-inner-spin-button, 
input[type="number"]::-webkit-outer-spin-button { 
  -webkit-appearance: none; 
  margin: 0; 
}
input[type="number"] {
  -moz-appearance: textfield; /* Firefox */
}

/* Tables */
.data-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
.data-table th, .data-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--glass);
}
.data-table th {
  background-color: var(--glass-2);
  color: var(--accent-2);
  font-weight: 700;
  text-transform: uppercase;
}
.data-table tr:hover {
  background-color: var(--glass-2);
}

.member-list span {
  display: inline-block;
  background-color: var(--bg-3);
  padding: 5px 10px;
  border-radius: 20px;
  margin: 5px;
  border: 1px solid var(--accent);
}

/* Modal Styling */
.modal {
  display: none; 
  position: fixed; 
  z-index: 100;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
  backdrop-filter: blur(5px);
}
.modal-content {
  background-color: var(--bg-2);
  margin: 10% auto;
  padding: 30px;
  border-radius: var(--card-radius);
  max-width: 500px;
  box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
  position: relative;
  border: 1px solid var(--accent);
}
.close-btn {
  color: var(--muted);
  float: right;
  font-size: 28px;
  font-weight: bold;
}
.close-btn:hover,
.close-btn:focus {
  color: var(--text-light);
  text-decoration: none;
  cursor: pointer;
}

/* Toast Message */
#toast-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    pointer-events: none;
}
.toast {
    background-color: var(--bg-3);
    color: var(--text-light);
    padding: 10px 20px;
    border-radius: 8px;
    margin-top: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
}
.toast.show {
    opacity: 1;
}
.toast.success { border-left: 5px solid var(--accent-2); }
.toast.error { border-left: 5px solid var(--danger); }

/* Utility */
.text-center { text-align: center; }
.my-4 { margin-top: 1.5rem; margin-bottom: 1.5rem; }
.flex-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }

/* Rent Box */
#rent-box {
  background: var(--bg-3);
  padding: 10px;
  border-radius: 8px;
  margin-top: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Footer */
footer {
  text-align: center;
  padding: 15px;
  color: var(--muted);
  font-size: 0.8rem;
  margin-top: 20px;
  border-top: 1px solid var(--glass);
}
</style>

<!-- ============================================== -->
<!-- FIREBASE SDKS AND INITIALIZATION (START) -->
<!-- ============================================== -->
<script type="module">
    // Core imports for CDN (using version 11.6.1 for stability)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global Firebase variables accessible to the main script
    window.db = null;
    window.auth = null;
    window.userId = null;
    window.isAuthReady = false;

    // Mandatory Canvas global variables
    window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    let finalFirebaseConfig = null;
    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
        try {
            finalFirebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("Configuration Error: Failed to parse __firebase_config. Please check the JSON format.", e);
        }
    }
    
    /**
     * Define the Firestore reference path function globally.
     * Returns a valid DocumentReference or null if Firebase is not initialized.
     */
    window.getRoomDocRef = () => {
      if (!window.db || !window.userId || !window.appId) {
          return null;
      }
      // Private data path: /artifacts/{appId}/users/{userId}/{your_collection_name}/{documentId}
      const collectionPath = `artifacts/${window.appId}/users/${window.userId}/roomData`;
      return doc(window.db, collectionPath, 'currentRoomState');
    };

    /**
     * Initializes Firebase App, performs custom authentication, and sets up data loading.
     */
    async function initializeFirebaseAndAuth() {
      if (!finalFirebaseConfig) {
          console.error("CRITICAL: Firebase configuration missing. Cannot initialize.");
          // Update local state to indicate failure
          window.isAuthReady = true; 
          document.getElementById('user-id-display').textContent = 'Config Error';
          window.showToast?.('error', 'Critical configuration missing. Cannot connect to database.');
          return;
      }

      try {
        const app = initializeApp(finalFirebaseConfig);
        window.db = getFirestore(app);
        window.auth = getAuth(app);
        
        // Authentication logic
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        console.log(`Attempting Firebase sign-in... Custom token present: ${!!authToken}`);
        
        if (authToken) {
          await signInWithCustomToken(window.auth, authToken);
        } else {
          await signInAnonymously(window.auth);
        }
        
        window.userId = window.auth.currentUser?.uid || crypto.randomUUID();
        window.isAuthReady = true;

        console.log(`Firebase ready. User ID: ${window.userId}`);
        
        // Start loading data after successful authentication
        if (window.loadData) {
           window.loadData();
        }

      } catch (e) {
        console.error("Firebase initialization or authentication failed:", e);
        // Note: The main script's showToast function might not be available immediately.
        document.getElementById('user-id-display').textContent = 'Auth Failed';
        window.showToast?.('error', 'Firebase connection failed. Check console for details (e.g., security rules, configuration).');
        window.isAuthReady = true; 
      }
    }

    // --- Execution ---
    // If config is successfully loaded, start the initialization process.
    if (finalFirebaseConfig) {
      initializeFirebaseAndAuth();
    } else {
      // Config failed to load, set authReady immediately and update display via DOMContentLoaded
      window.isAuthReady = true;
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('user-id-display').textContent = 'Config Error';
      });
    }

    // Expose necessary Firestore functions globally for the main script
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.getAuth = getAuth; 
</script>
<!-- ============================================== -->
<!-- FIREBASE SDKS AND INITIALIZATION (END) -->
<!-- ============================================== -->


</head>
<body>

<div class="container">
  <div class="flex-row">
    <h1>Room Expense Tracker</h1>
    <div class="flex-row">
      <button class="btn btn-secondary" onclick="document.getElementById('pdfModal').style.display='block';"><i class="fas fa-file-pdf"></i> PDF Export</button>
      <button class="btn btn-danger" onclick="resetValues();"><i class="fas fa-trash-alt"></i> Reset All</button>
    </div>
  </div>

  <p class="text-center" style="color:var(--muted); font-size:0.9rem;">
    User ID: <span id="user-id-display">Loading...</span>
  </p>

  <div class="grid my-4">

    <!-- 1. ADD MEMBER CARD -->
    <div class="card">
      <h2><i class="fas fa-users"></i> Room Members</h2>
      <div id="member-list" class="member-list"></div>
      
      <div class="flex-row" style="margin-top: 15px;">
        <input type="text" id="member-name" placeholder="Member Name" style="margin-bottom: 0; width: auto; flex-grow: 1; margin-right: 10px;">
        <button class="btn btn-primary" onclick="addMember();"><i class="fas fa-plus"></i> Add</button>
      </div>
    </div>

    <!-- 2. ADD EXPENSE CARD -->
    <div class="card">
      <h2><i class="fas fa-receipt"></i> Add Expense</h2>
      <input type="text" id="expense-name" placeholder="Expense Description" required>
      <input type="number" id="expense-amount" placeholder="Amount (e.g., 500)" required min="0">
      
      <label style="color: var(--muted); margin-bottom: 5px; display: block;">Paid By:</label>
      <select id="expense-paid-by">
        <!-- Options populated by JS -->
      </select>
      
      <button class="btn btn-primary" onclick="addExpense();"><i class="fas fa-plus-circle"></i> Add Expense</button>
    </div>

    <!-- 3. RENT/COMMON EXPENSE CARD -->
    <div class="card">
      <h2><i class="fas fa-home"></i> Common Expense (e.g., Rent)</h2>
      <p style="color:var(--muted); font-size:0.9rem;">This amount is split equally among all members.</p>
      
      <div id="rent-box">
        <span style="font-size: 1.2rem; font-weight: 700;">Rent Amount: <span id="current-rent">0</span></span>
        <button class="btn btn-secondary" onclick="document.getElementById('rentModal').style.display='block';"><i class="fas fa-edit"></i> Edit</button>
      </div>
    </div>
  </div>

  <!-- 4. EXPENSE TABLE -->
  <div class="card" style="margin-top: 20px;">
    <h2><i class="fas fa-list-alt"></i> Expense Breakdown</h2>
    <div style="overflow-x: auto;">
      <table id="expense-table" class="data-table">
        <thead>
          <tr>
            <th>Description</th>
            <th>Amount</th>
            <th>Paid By</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="expense-body">
          <!-- Rows populated by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 5. SUMMARY TABLE -->
  <div class="card" style="margin-top: 20px;">
    <h2><i class="fas fa-balance-scale"></i> Member Summary (Settlement)</h2>
    <div style="overflow-x: auto;">
      <table id="summary-table" class="data-table">
        <thead>
          <tr>
            <th>Member</th>
            <th>Total Paid</th>
            <th>Total Owed</th>
            <th>Settlement</th>
          </tr>
        </thead>
        <tbody id="summary-body">
          <!-- Rows populated by JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<footer>
  Developed with real-time Firebase Data Persistence.
</footer>


<!-- ============================================== -->
<!-- MODALS -->
<!-- ============================================== -->

<!-- 1. Rent/Common Expense Modal -->
<div id="rentModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="document.getElementById('rentModal').style.display='none';">&times;</span>
    <h2>Set Common Expense (Rent)</h2>
    <input type="number" id="new-rent-amount" placeholder="Enter new rent amount" min="0">
    <button class="btn btn-primary" onclick="setRent();"><i class="fas fa-check"></i> Set Rent</button>
  </div>
</div>

<!-- 2. PDF Export Modal -->
<div id="pdfModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="document.getElementById('pdfModal').style.display='none';">&times;</span>
    <h2>Generate PDF Report</h2>
    <p style="color:var(--muted);">Click below to generate a detailed PDF report of all expenses and the final settlement summary.</p>
    <button class="btn btn-primary" onclick="generatePdf();"><i class="fas fa-file-download"></i> Generate and Download PDF</button>
  </div>
</div>

<!-- 3. Custom Alert/Toast Container -->
<div id="toast-container"></div>


<!-- ============================================== -->
<!-- JAVASCRIPT LOGIC -->
<!-- ============================================== -->
<script>
// ==============================================
// GLOBAL STATE VARIABLES
// ==============================================
let people = []; // Starts empty now, loaded from Firebase. No "fault members".
let expenses = []; // List of all expenses
let rentValue = 0; // Common expense/rent
const TOAST_DURATION = 3000;
const MAX_RETRIES = 5;

// ==============================================
// FIREBASE DATA FUNCTIONS (REPLACING LOCALSTORAGE)
// ==============================================

/* Display User ID (for collaboration) */
function updateUserIdDisplay() {
    const display = document.getElementById('user-id-display');
    if (window.isAuthReady && window.userId) {
        display.textContent = window.userId;
    } else if (window.isAuthReady && !window.userId) {
        // This state means auth failed or config failed, and isAuthReady was set to true.
        display.textContent = display.textContent === 'Loading...' ? 'Auth Failed' : display.textContent;
    } else {
        display.textContent = 'Authenticating...';
        // Retry check if not ready immediately
        setTimeout(updateUserIdDisplay, 500); 
    }
}


/**
 * Save data to Firestore (Called after every state change).
 * Uses setDoc to overwrite the room state document.
 */
async function saveData() {
    const docRef = window.getRoomDocRef();
    if (!docRef) {
      console.warn("Save attempted, but Firestore document reference is invalid or database not ready.");
      window.showToast?.('error', 'Database not ready. Please wait for authentication.');
      return;
    }
    
    // Attempt to save data with exponential backoff for robustness
    for (let i = 0; i < MAX_RETRIES; i++) {
        try {
            await window.setDoc(docRef, {
                people: people, 
                expenses: expenses, 
                rent: rentValue
            }, { merge: false }); // Overwrite the whole document
            return; // Success
        } catch(e) {
            console.error(`Firestore save attempt ${i+1} failed:`, e);
            if (i < MAX_RETRIES - 1) {
                // Exponential backoff
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
            } else {
                showToast('error', 'Critical: Could not save data to database after multiple attempts. Check console.');
            }
        }
    }
}

/**
 * Load data from Firestore in real-time.
 */
function loadData() {
    if (!window.isAuthReady || !window.db) {
        console.warn("loadData called, but Firebase is not yet ready.");
        return;
    }
    const docRef = window.getRoomDocRef();
    if (!docRef) {
      // If docRef is null here, it means the config/auth failed and getRoomDocRef handles it
      console.warn("Load attempted, but Firestore document reference is invalid after auth check.");
      return;
    }

    window.onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            // 1. People
            if (data.people && Array.isArray(data.people)) {
                people = data.people;
            } else {
                people = [];
            }
            
            // 2. Expenses
            if (data.expenses && Array.isArray(data.expenses)) {
                expenses = data.expenses;
            } else {
                expenses = [];
            }
            
            // 3. Rent
            if (data.rent || data.rent === 0) {
                rentValue = data.rent;
            } else {
                rentValue = 0;
            }

            console.log("Data loaded from Firestore.");
            updateUI();

        } else {
            console.log("No data found in Firestore, initializing empty state.");
            // Document doesn't exist, ensure local state is clean
            people = [];
            expenses = [];
            rentValue = 0;
            updateUI();
        }
    }, (error) => {
        console.error("Error listening to Firestore changes:", error);
        showToast('error', 'Failed to connect to live database or permissions denied.');
    });
}

/**
 * Reset all data by deleting the Firestore document.
 */
function resetValues() {
    // Custom modal instead of confirm()
    // NOTE: Using window.confirm() here as it is a critical, irreversible action and custom modal implementation is complex for this simple case.
    const confirmReset = window.confirm('Clear ALL data, including members, expenses, and rent? This cannot be undone.');
    if (!confirmReset) return;
    
    const docRef = window.getRoomDocRef();
    if (!docRef) {
        showToast('error', 'Database not ready for reset.');
        return;
    }
    
    window.deleteDoc(docRef).then(() => {
        // The onSnapshot listener in loadData will automatically handle the local state reset.
        showToast('success', 'All data cleared from live database.');
    }).catch(e => {
        console.error('Firestore delete failed:', e);
        showToast('error', 'Failed to clear data from database.');
    });
}


// ==============================================
// CORE LOGIC FUNCTIONS
// ==============================================

/* Add a new member */
function addMember() {
  const nameInput = document.getElementById('member-name');
  const name = nameInput.value.trim().toUpperCase();
  if (!name || people.includes(name)) {
    showToast('error', 'Invalid or duplicate member name.');
    return;
  }
  people.push(name);
  nameInput.value = '';
  saveData(); // Save to Firestore
  showToast('success', `${name} added.`);
}

/* Remove a member */
function removeMember(name) {
  if (!window.confirm(`Are you sure you want to remove ${name}? All related expenses will remain, but settlement will change.`)) return;

  people = people.filter(p => p !== name);
  
  // Note: expenses remain to keep a historical record of what was paid.
  // The summary logic handles settlement correctly even if members are removed.
  saveData(); // Save to Firestore
  showToast('success', `${name} removed.`);
}

/* Add an expense */
function addExpense() {
  const name = document.getElementById('expense-name').value.trim();
  const amount = parseFloat(document.getElementById('expense-amount').value);
  const paidBy = document.getElementById('expense-paid-by').value;
  
  if (!name || isNaN(amount) || amount <= 0 || !paidBy) {
    showToast('error', 'Please fill all expense fields correctly.');
    return;
  }

  expenses.push({
    id: Date.now(), // Simple unique ID
    description: name,
    amount: amount,
    paidBy: paidBy
  });

  document.getElementById('expense-name').value = '';
  document.getElementById('expense-amount').value = '';
  saveData(); // Save to Firestore
  showToast('success', `Expense "${name}" added.`);
}

/* Remove an expense */
function removeExpense(id) {
  if (!window.confirm('Are you sure you want to remove this expense?')) return;
  
  expenses = expenses.filter(e => e.id !== id);
  saveData(); // Save to Firestore
  showToast('success', 'Expense removed.');
}

/* Set Rent/Common Expense */
function setRent() {
  const newRent = parseFloat(document.getElementById('new-rent-amount').value);
  if (isNaN(newRent) || newRent < 0) {
    showToast('error', 'Please enter a valid rent amount (0 or greater).');
    return;
  }
  rentValue = newRent;
  document.getElementById('rentModal').style.display='none';
  saveData(); // Save to Firestore
  showToast('success', `Common expense set to ${newRent}.`);
}

// ==============================================
// UI UPDATES
// ==============================================

/* Update all UI components */
function updateUI() {
  updateUserIdDisplay();
  updateExpenseTable();
  updateMemberUI();
  updateRentBox();
  updateSummaryTable();
}

/* Update the member list and the "Paid By" selector */
function updateMemberUI() {
  const listDiv = document.getElementById('member-list');
  const paidBySelect = document.getElementById('expense-paid-by');
  listDiv.innerHTML = people.map(p => 
    `<span>${p} <i class="fas fa-times-circle" style="cursor:pointer; color:var(--danger);" onclick="removeMember('${p}')"></i></span>`
  ).join('');

  // Update Paid By Selector
  paidBySelect.innerHTML = people.map(p => `<option value="${p}">${p}</option>`).join('');
  if (people.length === 0) {
    paidBySelect.innerHTML = '<option value="" disabled selected>Add members first</option>';
  }
}

/* Update rent display */
function updateRentBox() {
  document.getElementById('current-rent').textContent = formatCurrency(rentValue);
}

/* Update the detailed expense table */
function updateExpenseTable() {
  const tbody = document.getElementById('expense-body');
  tbody.innerHTML = expenses.map(e => `
    <tr>
      <td>${e.description}</td>
      <td>${formatCurrency(e.amount)}</td>
      <td>${e.paidBy}</td>
      <td><button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeExpense(${e.id})"><i class="fas fa-trash-alt"></i></button></td>
    </tr>
  `).join('');
}

/* Update the settlement summary table */
function updateSummaryTable() {
  const summary = calculateSettlement();
  const tbody = document.getElementById('summary-body');
  tbody.innerHTML = people.map(p => {
    const data = summary[p] || { totalPaid: 0, totalOwed: 0, balance: 0 };
    let settlementText = '';
    let rowClass = '';
    
    if (data.balance > 0) {
      settlementText = `<span style="color: ${varToHex('--accent-2')}; font-weight: bold;">Receives ${formatCurrency(data.balance)}</span>`;
      rowClass = 'receives';
    } else if (data.balance < 0) {
      settlementText = `<span style="color: ${varToHex('--danger')}; font-weight: bold;">Owes ${formatCurrency(Math.abs(data.balance))}</span>`;
      rowClass = 'owes';
    } else {
      settlementText = `Settled`;
    }

    return `
      <tr class="${rowClass}">
        <td>${p}</td>
        <td>${formatCurrency(data.totalPaid)}</td>
        <td>${formatCurrency(data.totalOwed)}</td>
        <td>${settlementText}</td>
      </tr>
    `;
  }).join('');
}


// ==============================================
// UTILITY & CALCULATIONS
// ==============================================

/* Calculate the final settlement for each member */
function calculateSettlement() {
  const totalMembers = people.length;
  if (totalMembers === 0) return {};
  
  // 1. Initial structure for summary
  const summary = people.reduce((acc, name) => {
    acc[name] = { totalPaid: 0, totalOwed: 0, balance: 0 };
    return acc;
  }, {});

  // 2. Individual Expenses
  expenses.forEach(e => {
    const splitAmount = e.amount / totalMembers;
    
    // Add to Total Paid
    if (summary[e.paidBy]) {
      summary[e.paidBy].totalPaid += e.amount;
    }

    // Add to Total Owed (everyone owes the split amount)
    people.forEach(p => {
      summary[p].totalOwed += splitAmount;
    });
  });

  // 3. Common Expense (Rent)
  if (rentValue > 0) {
    const rentSplit = rentValue / totalMembers;
    people.forEach(p => {
      // Everyone owes their share of the rent
      summary[p].totalOwed += rentSplit;
    });
  }

  // 4. Calculate Final Balance (Paid - Owed)
  Object.keys(summary).forEach(name => {
    summary[name].balance = summary[name].totalPaid - summary[name].totalOwed;
  });

  return summary;
}

/* Helper to format numbers as currency */
function formatCurrency(amount) {
  return amount.toLocaleString('en-IN', { style: 'currency', currency: 'INR' }); // Using INR as a common currency for the region
}

/* Helper to get CSS variable hex value */
function varToHex(variableName) {
  const style = getComputedStyle(document.body);
  const color = style.getPropertyValue(variableName).trim();
  // Simple check to ensure it's a color format (might need advanced parsing for RGBA)
  if (color.startsWith('#')) return color;
  // Fallback for simple colors
  if (variableName === '--accent-2') return '#1de9b6'; 
  if (variableName === '--danger') return '#ff5252'; 
  return '#ffffff';
}

/* ==============================================
   TOAST NOTIFICATIONS (Custom alert)
   ============================================== */
function showToast(type, message) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.classList.add('toast', type);
    toast.textContent = message;
    
    container.appendChild(toast);
    
    // Use requestAnimationFrame to ensure the element is added before applying the 'show' class
    requestAnimationFrame(() => {
        toast.classList.add('show');
    });

    setTimeout(() => {
        toast.classList.remove('show');
        toast.addEventListener('transitionend', () => toast.remove());
    }, TOAST_DURATION);
}

/* ==============================================
   PDF GENERATION (using jspdf and jspdf-autotable)
   ============================================== */
function generatePdf() {
    document.getElementById('pdfModal').style.display='none';
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const settlement = calculateSettlement();
    const currentDate = new Date().toLocaleDateString();

    let y = 20;

    // Title
    doc.setFontSize(20);
    doc.text("Room Expense Settlement Report", 105, y, null, null, "center");
    y += 10;
    doc.setFontSize(10);
    doc.text(`Generated on: ${currentDate} | User ID: ${window.userId || 'N/A'}`, 105, y, null, null, "center");
    y += 15;

    // Rent Summary
    doc.setFontSize(14);
    doc.text(`Common Expense/Rent: ${formatCurrency(rentValue)}`, 14, y);
    y += 10;
    
    // Expense Breakdown Table
    doc.setFontSize(16);
    doc.text("1. Expense Breakdown", 14, y);
    y += 5;
    
    const expenseData = expenses.map(e => [
      e.description, 
      formatCurrency(e.amount), 
      e.paidBy
    ]);
    
    doc.autoTable({
      startY: y,
      head: [['Description', 'Amount', 'Paid By']],
      body: expenseData,
      styles: { fillColor: [44, 83, 100] },
      headStyles: { fillColor: [32, 58, 67] },
      margin: { top: 10, left: 14, right: 14 },
      didDrawPage: (data) => { y = data.cursor.y; }
    });

    // Settlement Summary Table
    y += 10; // Add margin
    doc.setFontSize(16);
    doc.text("2. Final Settlement Summary", 14, y);
    y += 5;
    
    const summaryData = people.map(p => {
      const data = settlement[p] || { totalPaid: 0, totalOwed: 0, balance: 0 };
      let settlementText = 'Settled';
      if (data.balance > 0) {
        settlementText = `Receives ${formatCurrency(data.balance)}`;
      } else if (data.balance < 0) {
        settlementText = `Owes ${formatCurrency(Math.abs(data.balance))}`;
      }
      return [
        p, 
        formatCurrency(data.totalPaid), 
        formatCurrency(data.totalOwed), 
        settlementText
      ];
    });

    doc.autoTable({
      startY: y,
      head: [['Member', 'Total Paid', 'Total Owed', 'Settlement']],
      body: summaryData,
      styles: { fillColor: [44, 83, 100] },
      headStyles: { fillColor: [32, 58, 67] },
      margin: { top: 10, left: 14, right: 14 }
    });
    
    doc.save("Room_Expense_Report.pdf");
    showToast('success', 'PDF report generated and downloaded.');
}

/* helpers */
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

/* Event saves and modal closing */
window.addEventListener('DOMContentLoaded', () => {
    // Start initial display update. loadData is called automatically upon successful authentication.
    updateUserIdDisplay(); 
}); 

// Close modal on backdrop click
document.querySelectorAll('.modal').forEach(mod => {
  mod.addEventListener('click', (e) => {
    if (e.target === mod) {
      mod.style.display = 'none';
    }
  });
});
</script>

</body>
</html>
