<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no" />
<title>Room Expense Tracker -- Dark Elegant</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg-1:#0f2027;
  --bg-2:#203a43;
  --bg-3:#2c5364;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.03);
  --accent: #00c6ff;
  --accent-2: #1de9b6;
  --danger: #ff5252;
  --text-light: #e6f7ff;
  --muted: #9fb4bf;
  --card-radius: 14px;
  --glass-blur: 8px;
  --shadow: 0 8px 30px rgba(2,8,16,0.6);
  --glass-border: rgba(255,255,255,0.06);
  --success: #7ef0b7;
  --color-1: #00c6ff;
  --color-2: #1de9b6;
  --color-3: #ff6b6b;
  --color-4: #ffd700;
  --color-5: #b36eef;
}

/* Page background */
html,body{
  height:100%;
  margin:0;
  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  color:var(--text-light);
  background: linear-gradient(135deg,var(--bg-1),var(--bg-2) 45%,var(--bg-3));
  background-attachment: fixed;
  padding:18px;
  box-sizing:border-box;
}

/* App container */
.app {
  max-width:980px;
  margin: 10px auto;
  display:flex;
  flex-direction:column;
  gap:16px;
}

/* Sticky header */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 16px;
  border-radius:var(--card-radius);
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  backdrop-filter: blur(var(--glass-blur));
  box-shadow: var(--shadow);
  border: 1px solid var(--glass-border);
  position: sticky;
  top: 12px;
  z-index: 60;
}
.header .title {
  display:flex;
  gap:12px;
  align-items:center;
}
.logo {
  width:44px;height:44px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  background: linear-gradient(135deg,var(--accent),var(--accent-2));
  color:#002b34;font-weight:700;
  box-shadow: 0 6px 14px rgba(0,0,0,0.45);
  font-size:20px;
}
.header h1{font-size:18px;margin:0;color:var(--text-light);letter-spacing:0.2px;}
.header .nav {
  display:flex;
  gap:8px;
  align-items:center;
}
.icon-btn {
  background:transparent;border:0;color:var(--muted);
  padding:8px;border-radius:10px;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;
  transition: all .16s ease;
}
.icon-btn:hover { transform: translateY(-3px); color:var(--accent); box-shadow: 0 6px 18px rgba(0,198,255,0.06); }
.icon-btn.primary { color: var(--accent); }

/* Main glass card */
.container {
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border-radius: var(--card-radius);
  padding:18px;
  box-shadow: var(--shadow);
  border:1px solid var(--glass-border);
}

/* Inputs & controls */
.controls {
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:8px;
}
.controls input[type="number"],
.controls input[type="text"],
.controls select{
  min-width:150px;
  max-width:260px;
  flex:1 1 220px;
  background: transparent;
  border:1px solid rgba(255,255,255,0.06);
  color:var(--text-light);
  padding:10px 12px;border-radius:10px;
  outline:none;
  transition: box-shadow .15s ease, transform .12s ease;
}
.controls input::placeholder{ color: rgba(255,255,255,0.38); }
.controls input:focus{ box-shadow: 0 6px 20px rgba(0,198,255,0.07); transform: translateY(-2px); border-color: var(--accent); }

/* Buttons */
.btn {
  background: linear-gradient(90deg,var(--accent),var(--accent-2));
  color:#002b34;border:0;padding:10px 12px;border-radius:10px;
  font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;
  transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}
.btn:hover{ transform: translateY(-3px); box-shadow: 0 10px 24px rgba(2,198,255,0.08); }
.btn.ghost { background: transparent; color: var(--muted); border:1px solid rgba(255,255,255,0.04); }
.btn.danger { background: linear-gradient(90deg,#ff6b6b,#ff5252); color: white; }
.btn.warning { background: linear-gradient(90deg,#ffd700,#ffb700); color: #3c3c3c; }


/* Layout for the table card */
.section-title { display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; }
.section-title h2 { margin:0; font-size:16px; color:var(--text-light); }
.small-muted { color:var(--muted); font-size:13px; }

/* Table wrapper: scrollable with sticky header */
.table-wrap {
  overflow:auto;
  max-height:360px;
  border-radius:10px;
  padding:8px;
  border:1px solid rgba(255,255,255,0.03);
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
  -webkit-overflow-scrolling: touch;
}

/* Tables (expense & report) */
table {
  width:100%;
  border-collapse:separate;
  border-spacing:0 8px;
  min-width:600px;
  color:var(--text-light);
}
thead th {
  position: sticky;
  top:0;
  z-index:10;
  text-align:left;
  padding:10px 12px;
  font-weight:700;
  font-size:13px;
  color:var(--text-light);
  background: linear-gradient(180deg, rgba(2,8,16,0.6), rgba(2,8,16,0.8));
  border-bottom: 1px solid rgba(255,255,255,0.03);
  backdrop-filter: blur(6px);
}
tbody td {
  padding:12px;
  font-size:14px;
  vertical-align:middle;
  background: transparent;
}
tbody tr {
  transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
  border-radius:8px;
  display:table-row;
}
tbody tr td:first-child { border-top-left-radius:8px; border-bottom-left-radius:8px; }
tbody tr td:last-child { border-top-right-radius:8px; border-bottom-right-radius:8px; }

/* Alternating rows */
tbody tr:nth-child(odd) td {
  background: rgba(255,255,255,0.03);
}
tbody tr:nth-child(even) td {
  background: rgba(255,255,255,0.02);
}
tbody tr:hover td {
  transform: translateY(-4px);
  box-shadow: 0 10px 30px rgba(2,8,16,0.6);
}

/* Action buttons in table */
.table-btn {
  background:transparent;border:0;color:var(--muted);
  padding:8px;border-radius:8px;cursor:pointer;
  transition: all .12s ease;
}
.table-btn:hover { color: var(--danger); transform: translateY(-2px); }

/* New row highlight animation */
@keyframes rowIn {
  0% { opacity:0; transform: translateY(14px) scale(.995); box-shadow: none; }
  40% { opacity:1; transform: translateY(0) scale(1.005); box-shadow: 0 10px 28px rgba(0,198,255,0.06); }
  100% { transform: translateY(0) scale(1); box-shadow:none; }
}
.new-row td { animation: rowIn .8s ease both; outline: 2px solid rgba(0,198,255,0.12); }

/* Highlight pulse after add (temporary) */
@keyframes pulseGlow {
  0% { box-shadow: 0 0 0 0 rgba(0,198,255,0.18); }
  60% { box-shadow: 0 0 12px 6px rgba(0,198,255,0.08); }
  100% { box-shadow: none; }
}

/* Modal styles with animation */
.modal {
  display:none; position:fixed; inset:0;
  background: linear-gradient(180deg, rgba(2,8,16,0.6), rgba(2,8,16,0.6));
  backdrop-filter: blur(4px);
  align-items:center; justify-content:center;
  z-index:120;
  padding:18px;
}
.modal.open { display:flex; animation: modalIn .28s cubic-bezier(.2,.9,.3,1); }
@keyframes modalIn {
  from { opacity:0; transform: translateY(10px) scale(.995); }
  to { opacity:1; transform: translateY(0) scale(1); }
}
.modal-content {
  width:100%; max-width:520px; border-radius:12px;
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  border:1px solid rgba(255,255,255,0.04);
  padding:16px; box-shadow: 0 12px 40px rgba(0,0,0,0.6);
  position:relative;
}

/* Close button */
.close-btn {
  position:absolute; right:12px; top:12px; border:0; padding:8px;
  border-radius:8px; cursor:pointer; background: rgba(255,255,255,0.02);
  color: var(--muted);
}
.close-btn:hover { color: white; transform: scale(1.06); background: rgba(255,255,255,0.03); }

/* Checkbox grid (split) */
.checkbox-grid {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(110px,1fr));
  gap:8px; margin-top:8px;
}
.split-chip {
  display:flex; align-items:center; justify-content:center;
  padding:8px 12px; border-radius:999px; cursor:pointer;
  background: rgba(255,255,255,0.02); color:var(--text-light);
  transition: all .18s ease;
  border:1px solid rgba(255,255,255,0.02);
}
.split-chip input { display:none; }
.split-chip.checked { background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#002b34; box-shadow: 0 8px 26px rgba(2,198,255,0.06); transform: translateY(-3px); }

/* Floating Add button (mobile-friendly) */
#quickAddBtn {
  position: fixed; right:18px; bottom:18px; width:62px; height:62px; border-radius:50%;
  border:0; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer;
  background: linear-gradient(90deg,var(--accent),var(--accent-2)); color:#002b34; box-shadow: 0 12px 38px rgba(2,198,255,0.12);
  z-index:80;
}
#quickAddBtn:hover { transform: translateY(-4px); }

/* Toast (notifications) */
.toast-wrap {
  position: fixed; right:18px; top:18px; z-index:200; display:flex; flex-direction:column; gap:10px;
}
.toast {
  min-width:220px; padding:10px 14px; border-radius:10px; color:#002b34; font-weight:700;
  display:flex; gap:10px; align-items:center; box-shadow: 0 10px 30px rgba(2,8,16,0.48);
  border: 1px solid rgba(255,255,255,0.04);
  background: linear-gradient(90deg,var(--success), #d7ffd8);
  opacity:0; transform: translateY(-8px) scale(.995);
  animation: toastIn .28s cubic-bezier(.22,.9,.3,1) forwards;
}
.toast.error { background: linear-gradient(90deg,#ffb2b2,#ff8686); color: #2b0b0b; }
@keyframes toastIn { to { opacity:1; transform: translateY(0) scale(1); } }

/* Footer */
.footer {
  text-align:center; color:var(--muted); font-size:13px; padding:8px 4px;
}

/* Responsive adjustments */
@media (max-width:720px){
  .header { padding:10px; }
  .controls { gap:8px; }
  .table-wrap { max-height:280px; }
  table { min-width:580px; } /* Increased min-width for new column */
  .modal-content { max-width:92%; padding:14px; }
  #quickAddBtn { width:56px; height:56px; font-size:20px; right:14px; bottom:14px; }
}
@media (max-width:460px){
  .controls { flex-direction:column; align-items:stretch; }
  .header { gap:8px; }
  .logo { width:40px;height:40px;font-size:18px; }
  table { min-width:500px; font-size:13px; } /* Adjusted min-width */
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">
      <div class="logo">RT</div>
      <div>
        <h1>Room Expense Tracker</h1>
        <div class="small-muted">Dark Elegant</div>
      </div>
    </div>
    <div class="nav">
      <button class="icon-btn" onclick="scrollToTop()" title="Home"><i class="fas fa-home"></i></button>
      <button class="icon-btn" onclick="openAddExpenseModal()" title="Add Expense"><i class="fas fa-plus"></i></button>
      <button class="icon-btn" onclick="openReportModal()" title="Reports"><i class="fas fa-chart-pie"></i></button>
      <button class="icon-btn" onclick="openMemberEditor()" title="Members"><i class="fas fa-users"></i></button>
    </div>
  </div>

  <div class="container">
    <div class="section-title">
      <h2>üè† Overview</h2>
      <div class="small-muted">Manage shared expenses & rent</div>
    </div>

    <div class="controls">
      <input id="rent" type="text" placeholder="Total Room Rent (AED)" readonly aria-label="Current Rent Value">
      <button class="btn" onclick="openRentModal()"><i class="fas fa-dollar-sign"></i> Setup Rent</button>
      <button class="btn ghost" onclick="openMemberEditor()"><i class="fas fa-users"></i> Members</button>
      <button class="btn" onclick="openAddExpenseModal()"><i class="fas fa-plus"></i> Add Expense</button>
      <button class="btn" onclick="openReportModal()"><i class="fas fa-chart-pie"></i> Reports</button>
      <button class="btn danger" onclick="resetValues()"><i class="fas fa-trash"></i> Clear All Data</button>
    </div>

    <div class="section-title">
      <h2>Expenses</h2>
      <div class="small-muted" id="expensesCount">0 entries</div>
    </div>

    <div class="table-wrap" id="expenseWrap">
      <table id="expenseTable" aria-label="Expense table">
        <thead>
          <tr>
            <th>Payer</th>
            <th>Amount (AED)</th>
            <th>Description</th>
            <th>Shared Amount</th>
            <th>Shared With</th>
            <th style="text-align:right">Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">Room Expense Tracker ‚Ä¢ ¬© <span id="year"></span></div>
</div>

<button id="quickAddBtn" onclick="openAddExpenseModal()" title="Quick add"><i class="fas fa-plus"></i></button>

<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<div class="modal" id="expenseModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="addExpenseTitle">
    <button class="close-btn" onclick="closeAddExpenseModal()" aria-label="Close"><i class="fas fa-times"></i></button>
    <h3 id="addExpenseTitle">‚ûï Add Expense</h3>

    <div style="margin-top:6px;">
      <label class="small-muted">Payer</label>
      <select id="expensePayer" aria-label="Payer" style="width:100%; padding:10px; margin-top:6px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--text-light)"></select>
    </div>

    <div style="margin-top:10px;">
      <label class="small-muted">Amount (AED)</label>
      <input id="expenseAmount" type="number" onkeyup="updateSplitChart()" placeholder="Enter amount" aria-label="Expense amount in AED" style="margin-top:6px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text-light);">
    </div>
    
    <div style="margin-top:10px;">
      <label class="small-muted">Description (Optional)</label>
      <input id="expenseDescription" type="text" placeholder="e.g. Electricity bill, Groceries" aria-label="Expense description" style="margin-top:6px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text-light);">
    </div>
    
    <div id="splitChartContainer" style="margin-top:10px; height: 180px;">
        <canvas id="splitChart"></canvas>
    </div>

    <div style="margin-top:10px;">
      <label class="small-muted">Split with</label>
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button class="icon-btn" onclick="toggleSplitChecks(true)"><i class="fas fa-check-double"></i> All</button>
        <button class="icon-btn" onclick="toggleSplitChecks(false)"><i class="fas fa-times-circle"></i> None</button>
      </div>
      <div class="checkbox-grid" id="expenseSplit"></div>
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button class="btn ghost" onclick="closeAddExpenseModal()"><i class="fas fa-times"></i> Cancel</button>
      <button class="btn" id="addExpenseSubmit" onclick="submitExpense()"><i class="fas fa-check"></i> Add Expense</button>
    </div>
  </div>
</div>

<div class="modal" id="memberModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="memberTitle">
    <button class="close-btn" onclick="closeMemberEditor()" aria-label="Close"><i class="fas fa-times"></i></button>
    <h3 id="memberTitle">üë• Edit Members</h3>

    <div id="memberList" style="margin-top:8px;"></div>

    <div style="display:flex; gap:8px; margin-top:12px;">
      <input id="newMemberName" type="text" placeholder="Add new member" aria-label="New member name" style="padding:10px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.03); color:var(--text-light); flex:1;">
      <button class="btn" onclick="addMember()"><i class="fas fa-user-plus"></i> Add</button>
      <button class="btn ghost" onclick="saveMemberChanges()"><i class="fas fa-check"></i> Done</button>
    </div>
  </div>
</div>

<div class="modal" id="reportModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="reportTitle">
    <button class="close-btn" onclick="closeReportModal()" aria-label="Close"><i class="fas fa-times"></i></button>
    <h3 id="reportTitle">üìä Reports</h3>

    <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
      <button class="btn" onclick="generateExpenseReport()"><i class="fas fa-list"></i> Expense Report</button>
      <button class="btn" onclick="generateToPayReport()"><i class="fas fa-hand-holding-usd"></i> Balance Sheet</button>
      <button class="btn" onclick="generateSmartSettlement()"><i class="fas fa-exchange-alt"></i> Smart Settlement</button>
      <button class="btn ghost" onclick="showReportView('chart')"><i class="fas fa-chart-bar"></i> View Chart</button>
    </div>
    
    <div id="reportChartContainer" style="margin-top:12px; height: 300px; display: none;">
        <canvas id="balanceChart"></canvas>
    </div>

    <div class="table-wrap" id="reportTableWrap" style="margin-top:12px; max-height:320px;">
      <table id="reportTable"><thead></thead><tbody></tbody></table>
    </div>

    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
      <button class="btn warning" onclick="confirmSettlement()"><i class="fas fa-stamp"></i> Confirm & Clear Expenses</button>
      <button class="btn" onclick="downloadReportPDF()"><i class="fas fa-file-pdf"></i> PDF</button>
      <button class="btn" onclick="shareReportWhatsApp()"><i class="fab fa-whatsapp"></i> WhatsApp</button>
    </div>
  </div>
</div>

<div class="modal" id="rentModal" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="rentTitle">
    <button class="close-btn" onclick="closeRentModal()" aria-label="Close"><i class="fas fa-times"></i></button>
    <h3 id="rentTitle">üí∞ Set Room Rent</h3>

    <div style="margin-top:10px;">
      <label class="small-muted">Total Rent (AED)</label>
      <input id="rentInput" type="number" placeholder="Enter total rent" aria-label="Total Rent in AED" style="margin-top:6px; width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text-light);">
    </div>

    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:14px;">
      <button class="btn ghost" onclick="closeRentModal()"><i class="fas fa-times"></i> Cancel</button>
      <button class="btn" onclick="saveRent()"><i class="fas fa-check"></i> Save</button>
    </div>
  </div>
</div>

<script>
/* ---------------------------
   Data & initial variables
   --------------------------- */
// Start with an empty list of people
let people = []; 
// expense: { payer, amount, description, date, shared: [...], perShare }
let expenses = []; 
let rentValue = 0;
let currentReportType = 'settlement'; 
let balanceData = []; // Store calculated balance for charting/pdf

let balanceChartInstance = null; // Variable to hold the Report Chart.js instance
let splitChartInstance = null; // Variable to hold the Expense Split Chart.js instance

const chartColors = ['var(--color-1)', 'var(--color-2)', 'var(--color-3)', 'var(--color-4)', 'var(--color-5)'];

/* set copyright year */
document.getElementById('year').textContent = new Date().getFullYear();

/* ---------------------------
   Toast notifications
   --------------------------- */
function showToast(type='success', message='') {
  const wrap = document.getElementById('toastWrap');
  const t = document.createElement('div');
  t.className = 'toast' + (type==='error' ? ' error' : '');
  t.innerHTML = `<div style="font-size:16px;">${ type==='error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>' }</div><div style="flex:1">${message}</div>`;
  wrap.appendChild(t);
  // auto remove after 3s
  setTimeout(()=> {
    t.style.opacity = '0';
    t.style.transform = 'translateY(-8px)';
    setTimeout(()=> t.remove(), 350);
  }, 3000);
}

/* ---------------------------
   Members UI (editor with add/remove)
   --------------------------- */
function updateMemberUI() {
  const list = document.getElementById('memberList');
  list.innerHTML = '';
  people.forEach((p) => {
    const div = document.createElement('div');
    div.className = 'member-item';
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.alignItems = 'center';
    div.style.padding = '10px';
    div.style.margin = '6px 0';
    div.style.borderRadius = '10px';
    div.style.background = 'linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02))';
    // Use data-name for safer removal
    div.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><div style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#002b34;font-weight:700">${p[0]||'U'}</div><div style="font-weight:600">${p}</div></div><div><button class="btn ghost" onclick="removeMember('${p.replace(/'/g, "\\'")}')" aria-label="Remove ${p}"><i class="fas fa-trash"></i></button></div>`;
    list.appendChild(div);
  });

  // update payer select & split chips if modal open
  const sel = document.getElementById('expensePayer');
  if (sel) sel.innerHTML = people.map(p => `<option>${p}</option>`).join('');
}

/* Add / remove members */
function addMember() {
  const nameEl = document.getElementById('newMemberName');
  const name = (nameEl.value || '').trim();
  const nameUpper = name.toUpperCase(); // Force uppercase internally
  
  if (!name) { showToast('error', 'Please enter a name'); return; }
  
  // Case-insensitive duplicate check
  if (people.map(p => p.toUpperCase()).includes(nameUpper)) { 
    showToast('error', 'Member already exists (case insensitive)'); 
    nameEl.value=''; 
    return; 
  }
  
  people.push(nameUpper); // Store name as uppercase
  nameEl.value='';
  updateUI(); saveData();
  showToast('success','Member added');
}

function removeMember(name) {
  // name is already the uppercase version stored in the people array
  if (!confirm(`Remove member ${name}? This will update existing expense splits.`)) return;
  
  people = people.filter(p => p !== name);
  
  // 1. Remove member from shared lists in expenses & recalculate perShare
  expenses.forEach(e => { 
    e.shared = e.shared.filter(x => x !== name); 
    if (e.shared.length > 0) {
      e.perShare = +(e.amount / e.shared.length).toFixed(2);
    } else {
      e.perShare = 0; // No one left to share with
    }
    // Also update payer if the payer was removed (transfer to first available member)
    if (e.payer === name && people.length > 0) {
        e.payer = people[0];
        showToast('warning', `Payer for an expense (${e.amount.toFixed(2)}) was removed and transferred to ${e.payer}.`);
    } else if (e.payer === name && people.length === 0) {
        // If the last member is removed and they are a payer, remove the expense too.
        e.remove = true; 
    }
  });

  expenses = expenses.filter(e => !e.remove);

  updateUI(); saveData();
  showToast('success','Member removed and expenses updated');
}

function saveMemberChanges() { closeMemberEditor(); saveData(); showToast('success','Members updated'); }
function openMemberEditor() { document.getElementById('memberModal').classList.add('open'); document.getElementById('memberModal').ariaHidden = 'false'; updateMemberUI(); }
function closeMemberEditor() { document.getElementById('memberModal').classList.remove('open'); document.getElementById('memberModal').ariaHidden = 'true'; }

/* ---------------------------
   Expense Modal
   --------------------------- */
function openAddExpenseModal() {
  document.getElementById('expenseModal').classList.add('open');
  document.getElementById('expenseModal').ariaHidden = 'false';
  
  const sel = document.getElementById('expensePayer');
  sel.innerHTML = people.map(p => `<option>${p}</option>`).join('');
  
  // Reset other fields
  document.getElementById('expenseAmount').value = '';
  document.getElementById('expenseDescription').value = '';
  
  const split = document.getElementById('expenseSplit');
  split.innerHTML = '';
  
  people.forEach(p => {
    const id = 'chk_'+p;
    const label = document.createElement('label');
    label.className = 'split-chip checked'; // default checked
    label.innerHTML = `<input type="checkbox" id="${id}" value="${p}" checked><span>${p}</span>`;
    label.onclick = function(){
      const cb = this.querySelector('input');
      // Use requestAnimationFrame to ensure we read the intended new state
      requestAnimationFrame(() => {
        this.classList.toggle('checked', cb.checked);
        updateSplitChart(); // Update chart on chip click
      });
    };
    split.appendChild(label);
  });
  updateSplitChart(); // Initial chart rendering (should be 0 or empty)
}

function toggleSplitChecks(check) {
    document.querySelectorAll('#expenseSplit input[type="checkbox"]').forEach(cb => {
        cb.checked = check;
        cb.closest('.split-chip').classList.toggle('checked', check);
    });
    updateSplitChart(); // Update chart when toggling all/none
}

function closeAddExpenseModal() {
  document.getElementById('expenseModal').classList.remove('open');
  document.getElementById('expenseModal').ariaHidden = 'true';
  if(splitChartInstance) {
      splitChartInstance.destroy();
      splitChartInstance = null;
  }
}

// Function to render the real-time expense split chart (Donut Chart)
function updateSplitChart() {
    const amountRaw = document.getElementById('expenseAmount').value;
    const amount = parseFloat(amountRaw);
    const shared = [...document.querySelectorAll('#expenseSplit input')].filter(i=>i.checked).map(c => c.value);
    
    // Clear chart if input is invalid or no one is sharing
    if (!amount || amount <= 0 || isNaN(amount) || shared.length === 0) {
        if (splitChartInstance) splitChartInstance.destroy();
        splitChartInstance = null;
        return;
    }
    
    const perShare = +(amount / shared.length).toFixed(2);
    
    const labels = shared.map(p => `${p} (${perShare.toFixed(2)} AED)`);
    const dataValues = shared.map(() => perShare);
    
    // Use a subset of colors for the split members
    const backgroundColors = dataValues.map((_, i) => chartColors[i % chartColors.length]);

    if (splitChartInstance) splitChartInstance.destroy(); // Clear existing chart
    
    const ctx = document.getElementById('splitChart').getContext('2d');
    
    splitChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: dataValues,
                backgroundColor: backgroundColors,
                hoverOffset: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: { color: 'var(--text-light)', boxWidth: 10, padding: 8 }
                },
                title: {
                    display: true,
                    text: `Total: ${amount.toFixed(2)} AED`,
                    color: 'var(--text-light)',
                    padding: { top: 10, bottom: 0 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += new Intl.NumberFormat('en-AE', { style: 'currency', currency: 'AED' }).format(context.parsed);
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}


/* Submit expense (with validation + toasts + highlight) */
function submitExpense() {
  const payer = document.getElementById('expensePayer').value;
  const amountRaw = document.getElementById('expenseAmount').value;
  const description = document.getElementById('expenseDescription').value || 'General Expense';
  const amount = parseFloat(amountRaw);
  
  if (!amount || amount <= 0 || isNaN(amount)) {
    showToast('error','Please enter a valid amount');
    return;
  }
  
  const shared = [...document.querySelectorAll('#expenseSplit input')].filter(i=>i.checked).map(c => c.value);
  if (shared.length === 0) { showToast('error','Select at least one member'); return; }
  
  // Calculate perShare accurately, then convert back to number.
  const perShare = parseFloat((amount / shared.length).toFixed(2)); 
  
  const entry = { 
    payer, 
    amount: +amount.toFixed(2), 
    description,
    date: new Date().toISOString(), // Timestamp
    shared, 
    perShare 
  };
  
  expenses.push(entry);
  const newIndex = expenses.length - 1;
  updateExpenseTable();
  closeAddExpenseModal();
  saveData();
  // highlight last row
  highlightExpenseRow(newIndex);
  showToast('success','Expense added successfully');
}

/* highlight a row by index (temporary) */
function highlightExpenseRow(idx){
  const tbody = document.querySelector('#expenseTable tbody');
  const row = tbody.children[idx];
  if (!row) return;
  row.classList.add('new-row');
  setTimeout(()=> {
    row.style.animation = 'pulseGlow .9s ease';
  }, 350);
  setTimeout(()=> {
    row.classList.remove('new-row');
    row.style.animation = '';
  }, 2200);
}

/* ---------------------------
   Expense Table rendering
   --------------------------- */
function updateExpenseTable() {
  const tbody = document.querySelector('#expenseTable tbody');
  tbody.innerHTML = '';
  expenses.slice().reverse().forEach((e, originalIndex) => { // Reverse for latest first, originalIndex used for deletion
    // Calculate the current index in the non-reversed array
    const idx = expenses.length - 1 - expenses.findIndex(exp => exp === e); 

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:600" scope="row">${e.payer}</td>
      <td>${e.amount.toFixed(2)}</td>
      <td style="color:var(--muted); font-size:13px;" title="${new Date(e.date).toLocaleString()}">${e.description.substring(0, 20)}${e.description.length > 20 ? '...' : ''}</td>
      <td>${e.perShare.toFixed(2)}</td>
      <td>${e.shared.join(', ')}</td>
      <td style="text-align:right">
        <button class="table-btn" title="Remove" onclick="removeExpense(${idx})" aria-label="Remove expense ${e.description}"><i class="fas fa-trash"></i></button>
      </td>
    `;
    // We append to the front to show latest expense on top
    tbody.prepend(tr); 
  });
  document.getElementById('expensesCount').textContent = `${expenses.length} entries`;
}

/* remove expense */
function removeExpense(idx) {
  if(!confirm('Delete this expense?')) return;
  expenses.splice(idx,1);
  updateExpenseTable();
  saveData();
  showToast('success','Expense removed');
}

/* ---------------------------
   Reports
   --------------------------- */
function openReportModal() { 
  document.getElementById('reportModal').classList.add('open'); 
  document.getElementById('reportModal').ariaHidden = 'false'; 
  // 1. Generate the data (default to Balance Sheet)
  generateToPayReport(); 
  // 2. Ensure the table view is shown first
  showReportView('table'); 
}
function closeReportModal() { 
  document.getElementById('reportModal').classList.remove('open'); 
  document.getElementById('reportModal').ariaHidden = 'true'; 
  // Clean up the balance chart instance when closing
  if (balanceChartInstance) {
      balanceChartInstance.destroy(); 
      balanceChartInstance = null;
  }
}

// Helper to manage chart/table visibility
function showReportView(type = 'table') {
    const tableWrap = document.getElementById('reportTableWrap');
    const chartContainer = document.getElementById('reportChartContainer');

    if (type === 'chart') {
        // Show chart, hide table, and render the chart (if data exists)
        tableWrap.style.display = 'none';
        chartContainer.style.display = 'block';
        if (balanceData.length > 0 && currentReportType === 'toPay') {
             // Only render chart if the current report type is the Balance Sheet
             renderBalanceChart();
        } else {
             // If Balance Sheet is not generated, switch back to table and show a warning
             showReportView('table');
             showToast('error', 'Chart is only available for Balance Sheet report.');
        }
    } else {
        // Show table, hide chart
        tableWrap.style.display = 'block';
        chartContainer.style.display = 'none';
        if (balanceChartInstance) {
            balanceChartInstance.destroy(); // Destroy chart when switching to table view
            balanceChartInstance = null;
        }
    }
}

// 1. Full Expense List Report
function generateExpenseReport() {
  showReportView('table');
  currentReportType='expense'; 
  const table = document.getElementById('reportTable');
  let thead='<tr><th scope="col">Payer</th><th scope="col">Amount</th><th scope="col">Description</th><th scope="col">Shared Amount</th><th scope="col">Shared With</th></tr>';
  let tbody='';
  expenses.forEach(e=>{
    const per=(e.perShare).toFixed(2);
    tbody+=`<tr><td style="font-weight:600" scope="row">${e.payer}</td><td>${e.amount.toFixed(2)}</td><td>${e.description}</td><td>${per}</td><td>${e.shared.join(', ')}</td></tr>`;
  });
  table.innerHTML=`<thead>${thead}</thead><tbody>${tbody}</tbody>`;
}

// 2. Balance Sheet (Paid vs Owed) - Default View on Modal Open
function generateToPayReport() {
  currentReportType='toPay';
  const rent = rentValue || 0;
  const paid = {}, owe = {};
  balanceData = []; // Reset stored data

  people.forEach(p => { paid[p]=0; owe[p]=0; });
  
  // Calculate expenses paid and owed
  expenses.forEach(e => {
    const per = e.perShare;
    // Only count as owed if the person is in the split
    e.shared.forEach(p => owe[p] = (owe[p] || 0) + per);
    paid[e.payer] = (paid[e.payer] || 0) + e.amount;
  });
  
  const rentShare = (people.length > 0) ? (rent / people.length) : 0;
  const table = document.getElementById('reportTable');
  
  let thead='<tr><th scope="col">Name</th><th scope="col">Paid</th><th scope="col">Expenses Owed</th><th scope="col">Rent Share</th><th scope="col">Net Balance</th></tr>';
  let tbody='';

  people.forEach(p=>{
    const totalPaid = (paid[p]||0);
    const totalOwed = (owe[p]||0);
    const netBalance = +(totalPaid - totalOwed - rentShare).toFixed(2); // Store as number for chart
    
    // Store data for PDF/Chart
    balanceData.push({
        name: p, 
        paid: totalPaid.toFixed(2), 
        owed: totalOwed.toFixed(2), 
        rentShare: rentShare.toFixed(2), 
        netBalance: netBalance
    });

    const balanceClass = netBalance < 0 ? 'color:var(--danger)' : 'color:var(--success)';
    tbody+=`<tr><td style="font-weight:600" scope="row">${p}</td><td>${totalPaid.toFixed(2)}</td><td>${totalOwed.toFixed(2)}</td><td>${rentShare.toFixed(2)}</td><td style="${balanceClass}; font-weight:700">${netBalance.toFixed(2)}</td></tr>`;
  });
  
  // Render table first
  table.innerHTML=`<thead>${thead}</thead><tbody>${tbody}</tbody>`;
  
  // Switch to table view
  showReportView('table');
}

// Function to render the Chart.js Bar Chart
function renderBalanceChart() {
    if (balanceChartInstance) balanceChartInstance.destroy(); // Clear existing chart
    
    const ctx = document.getElementById('balanceChart').getContext('2d');
    const labels = balanceData.map(d => d.name);
    const netBalances = balanceData.map(d => d.netBalance);
    
    const data = {
        labels: labels,
        datasets: [{
            label: 'Net Balance (AED)',
            data: netBalances,
            backgroundColor: netBalances.map(v => v >= 0 ? 'rgba(33, 203, 137, 0.7)' : 'rgba(255, 82, 82, 0.7)'),
            borderColor: netBalances.map(v => v >= 0 ? '#1de9b6' : '#ff5252'),
            borderWidth: 1
        }]
    };
    
    const config = {
        type: 'bar',
        data: data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'AED',
                        color: 'var(--text-light)'
                    },
                    grid: { color: 'rgba(255,255,255,0.08)' },
                    ticks: { color: 'var(--muted)' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: 'var(--muted)' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: 'var(--text-light)' }
                },
                title: {
                    display: true,
                    text: 'Member Net Balance (Paid - Owed - Rent)',
                    color: 'var(--text-light)'
                }
            }
        }
    };
    
    balanceChartInstance = new Chart(ctx, config);
}


// 3. Smart Settlement (Minimum Transactions)
function generateSmartSettlement() {
  showReportView('table'); // Ensure table view is shown
  currentReportType='settlement';
  balanceData = []; // Clear previous data

  // --- START: Calculate Net Balance (Including Rent) ---
  const rent = rentValue || 0;
  const paid = {}, owe = {};
  let balances = {}; // This will hold the final net balance

  people.forEach(p => { paid[p]=0; owe[p]=0; balances[p]=0; });
  
  // 1. Calculate expenses paid and owed
  expenses.forEach(e => {
    const per = e.perShare;
    e.shared.forEach(p => owe[p] = (owe[p] || 0) + per);
    paid[e.payer] = (paid[e.payer] || 0) + e.amount;
  });
  
  // 2. Calculate Rent Share
  const rentShare = (people.length > 0) ? (rent / people.length) : 0;
  
  // 3. Calculate the FINAL NET BALANCE
  people.forEach(p=>{
    const totalPaid = (paid[p]||0);
    const totalOwed = (owe[p]||0);
    // Net Balance = (Paid - Expenses Owed - Rent Share)
    const netBalance = +(totalPaid - totalOwed - rentShare).toFixed(2);
    balances[p] = netBalance;
  });
  // --- END: Calculate Net Balance ---

  const table = document.getElementById('reportTable');

  // Check 1: Calculate the total absolute imbalance
  const totalImbalance = Object.values(balances).reduce((sum, val) => sum + Math.abs(val), 0);
  
  // If the total imbalance is near zero, settlement is complete.
  if (totalImbalance < 0.02) {
    balanceData = []; // Clear stored data
    table.innerHTML = `<tbody><tr><td style="text-align:center; padding:20px; color:var(--success); font-weight:700">üéâ All balances are settled, no one owes or is owed money!</td></tr></tbody>`;
    return; // Exit the function early
  }

  // 4. Prepare Debtors and Creditors lists based on Net Balance
  let debtors = [];
  let creditors = [];

  for (const [person, amount] of Object.entries(balances)) {
    // Negative balance = Ower/Debtor (owes money to the group)
    // Use a small tolerance check (0.01) to ignore floating point errors
    if (amount < -0.01) debtors.push({ name: person, amount: amount }); 
    // Positive balance = Receiver/Creditor (is owed money by the group)
    if (amount > 0.01) creditors.push({ name: person, amount: amount }); 
  }

  debtors.sort((a, b) => a.amount - b.amount); // Most debt first (most negative)
  creditors.sort((a, b) => b.amount - a.amount); // Most credit first (most positive)

  let transactions = [];
  let i = 0;
  let j = 0;

  // 5. Find Minimum Transactions (Greedy Algorithm)
  while (i < debtors.length && j < creditors.length) {
    let debtor = debtors[i];
    let creditor = creditors[j];
    
    // Amount to transfer is the smaller of the absolute debt or the credit
    let amount = Math.min(Math.abs(debtor.amount), creditor.amount);

    transactions.push({ from: debtor.name, to: creditor.name, amount: amount });

    // Update balances
    debtor.amount += amount;
    creditor.amount -= amount;

    // Move to next debtor/creditor if their balance is settled (near zero)
    if (Math.abs(debtor.amount) < 0.01) i++;
    if (creditor.amount < 0.01) j++;
  }
  
  balanceData = transactions; // Store transactions for PDF/Share

  // 6. Render the transaction table
  let html = `<thead><tr><th scope="col">Settlement Plan (${transactions.length} Transactions)</th></tr></thead><tbody>`;
  transactions.forEach(t => {
    html += `<tr><td style="color:var(--accent); font-weight:600; padding:15px;" scope="row">${t.from} pays ${t.to}: ${t.amount.toFixed(2)} AED</td></tr>`;
  });
  html += `</tbody>`;
  table.innerHTML = html;
}

// 4. Confirmation to clear all expenses
function confirmSettlement() {
  const totalExpenses = expenses.length;
  if (totalExpenses === 0) {
    showToast('error', 'There are no expenses to clear.');
    return;
  }
  
  if (!confirm(`WARNING: Are you sure everyone has settled their debts? This action will permanently remove all ${totalExpenses} expense records and cannot be undone. Rent setup will remain.`)) {
    return;
  }
  
  // Clear the expenses array
  expenses = [];
  
  // Update UI and storage
  updateUI();
  saveData();
  closeReportModal();
  showToast('success', `${totalExpenses} expenses successfully cleared! Ready for a new cycle.`);
}


/* PDF and WhatsApp share (Themed for Dark Mode) */
function downloadReportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Theme Variables
  const LIGHT_TEXT = '#e0e0e0'; // Light text color
  const ACCENT_COLOR = [0, 198, 255]; // Accent blue for headers (RGB)
  
  // Set default text color to light
  doc.setTextColor(LIGHT_TEXT);
  // Note: Applying full page background is complex in jspdf; styling focuses on table colors.
  
  // Set Title and Metadata
  doc.setFontSize(16);
  doc.text("üè† Room Expense Report", 10, 18);
  doc.setFontSize(10);
  doc.text(`Report: ${currentReportType.toUpperCase()} | Generated: ${new Date().toLocaleDateString()}`, 10, 24);

  // Define Dark Theme styles for the table
  const darkTableStyles = {
    startY: 32, // Start below the header text
    headStyles: {
      fillColor: ACCENT_COLOR, // Accent blue background for header
      textColor: [0, 0, 0], // Black text for contrast
      fontStyle: 'bold',
    },
    styles: {
      fontSize: 10,
      textColor: LIGHT_TEXT, // Light text for body
      fillColor: '#203a43', // Slightly darker shade for row background
      lineWidth: 0.1, // Small border
      lineColor: '#2c5364' // Dark line color
    },
    alternateRowStyles: {
      fillColor: '#2c5364', // Alternating row color (using a common background color)
    },
    // This allows custom styling based on row/cell content
    didDrawCell: (data) => {
        if (currentReportType === 'toPay' && data.column.dataKey === 4 && data.cell.section === 'body') {
            const netBalance = parseFloat(data.cell.raw);
            if (netBalance < 0) {
                // Red for negative balance
                doc.setTextColor(255, 82, 82); 
            } else if (netBalance > 0) {
                // Green for positive balance
                doc.setTextColor(126, 240, 183); 
            }
        }
    }
  };


  if (currentReportType === 'toPay') {
      const head = [['Name', 'Paid (AED)', 'Owed (AED)', 'Rent Share (AED)', 'Net Balance (AED)']];
      const body = balanceData.map(d => [d.name, d.paid, d.owed, d.rentShare, d.netBalance.toFixed(2)]);
      doc.autoTable({ head: head, body: body, ...darkTableStyles });
  } else if (currentReportType === 'settlement') {
      const head = [['Payment Instruction', 'Amount (AED)']];
      const body = balanceData.map(t => [`${t.from} pays ${t.to}`, t.amount.toFixed(2)]);
      doc.autoTable({ head: head, body: body, ...darkTableStyles });
  } else {
      // For Expense Report (Reads from HTML, which is less ideal for styling, but still applies global styles)
      doc.autoTable({ html: "#reportTable", ...darkTableStyles });
  }

  doc.save("Room_Expense_Report.pdf");
}

function shareReportWhatsApp() {
  let text="*üè† Room Expense Report*\n\n";
  
  if (currentReportType === 'toPay') {
      text += "*üìä BALANCE SHEET (Net Balance)*\n";
      balanceData.forEach(d => {
          const sign = d.netBalance >= 0 ? '+' : '';
          text += `‚Ä¢ *${d.name}*: ${sign}${d.netBalance.toFixed(2)} AED\n`;
      });
      text += "\n_Positive balance: Amount you are owed._\n_Negative balance: Amount you owe._";
  } else if (currentReportType === 'settlement') {
      if (balanceData.length === 0) {
          text += "*ü§ù SMART SETTLEMENT PLAN*\nüéâ All balances are settled, no one owes or is owed money! üéâ";
      } else {
          text += "*ü§ù SMART SETTLEMENT PLAN*\n";
          balanceData.forEach(t => {
              text += `‚û°Ô∏è *${t.from}* pays *${t.to}*: ${t.amount.toFixed(2)} AED\n`;
          });
      }
  } else {
      text += "*üìù EXPENSE LIST*\n";
      // Fallback to reading the visible table
      document.querySelectorAll("#reportTable tbody tr").forEach(tr=>{
        // Use a simple, readable format for the table rows
        const cells = Array.from(tr.children).map(td=>td.textContent.trim());
        text+=`\n- Payer: ${cells[0]}, Amount: ${cells[1]}, Description: ${cells[2]}`;
      });
  }
  
  text+="\n\n_Generated by Room Expense Tracker_";
  window.open("https://wa.me/?text="+encodeURIComponent(text),"_blank");
}

/* ---------------------------
   Rent Modal functions
   --------------------------- */
function openRentModal() {
  document.getElementById('rentModal').classList.add('open');
  document.getElementById('rentModal').ariaHidden = 'false';
  document.getElementById('rentInput').value = rentValue || '';
  setTimeout(()=> document.getElementById('rentInput').focus(), 100);
}
function closeRentModal() {
  document.getElementById('rentModal').classList.remove('open');
  document.getElementById('rentModal').ariaHidden = 'true';
}
function saveRent() {
  const val = parseFloat(document.getElementById('rentInput').value);
  if (val < 0 || isNaN(val)) { showToast('error','Enter a valid rent (0 or positive)'); return; }
  rentValue = +val.toFixed(2);
  updateRentBox();
  closeRentModal();
  saveData();
  showToast('success','Rent updated');
}

/* update rent display in the same textbox (total and per-head) */
function updateRentBox(){
  const rentBox = document.getElementById('rent');
  const perHead = people.length > 0 ? (rentValue / people.length) : 0;
  if (rentValue > 0) {
    rentBox.value = `Total: ${rentValue.toFixed(2)} AED  |  Per head: ${perHead.toFixed(2)} AED`;
    rentBox.dataset.value = rentValue;
  } else {
    rentBox.value = 'Total Room Rent (AED)';
    rentBox.dataset.value = 0;
  }
}

/* ---------------------------
   Reset / Save / Load
   --------------------------- */
function resetValues() {
  if(!confirm('Clear ALL data, including members, expenses, and rent? This cannot be undone.')) return;
  rentValue = 0;
  expenses=[];
  people = []; // Reset to empty list
  updateUI();
  saveData();
  showToast('success','All data cleared');
}

/* Save to localStorage */
function saveData() {
  try {
    localStorage.setItem('roomExpenseData', JSON.stringify({
      people, expenses, rent: rentValue
    }));
  } catch(e) {
    console.error('Save failed', e);
  }
}

/* Load from localStorage */
function loadData() {
  try {
    const data = JSON.parse(localStorage.getItem('roomExpenseData') || '{}');
    // Schema check for robustness
    if (data.people && Array.isArray(data.people)) people = data.people;
    if (data.expenses && Array.isArray(data.expenses)) expenses = data.expenses;
    if (data.rent || data.rent === 0) rentValue = data.rent;
  } catch(e){ console.warn('Load failed, resetting to default.', e); }
  updateUI();
}

/* update UI pieces */
function updateUI() {
  updateExpenseTable();
  updateMemberUI();
  updateRentBox();
}

/* helpers */
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

/* Event saves */
window.addEventListener('DOMContentLoaded', loadData);
// Note: Removed beforeunload save as it can be unreliable on mobile/single page apps. saveData() is called after every major action.

/* small enhancement: close modal on backdrop click */
document.querySelectorAll('.modal').forEach(mod => {
  mod.addEventListener('click', (e) => {
    if (e.target === mod) {
      // Check which modal is open and call its specific close function
      if (mod.id === 'expenseModal') closeAddExpenseModal();
      else if (mod.id === 'memberModal') closeMemberEditor();
      else if (mod.id === 'reportModal') closeReportModal();
      else if (mod.id === 'rentModal') closeRentModal();
    }
  });
});
</script>
</body>
</html>
