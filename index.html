<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no" />
<title>Room Expense Tracker -- Dark Elegant</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root{
  --bg-1:#0f2027;
  --bg-2:#203a43;
  --bg-3:#2c5364;
  --glass: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.03);
  --accent: #00c6ff;
  --accent-2: #1de9b6;
  --danger: #ff5252;
  --text-light: #e6f6ff;
  --text-muted: #a0a8b9;
  --shadow: 0 4px 6px rgba(0,0,0,0.2), 0 10px 20px rgba(0,0,0,0.15);
}
body{
  font-family: 'Inter', sans-serif;
  background: var(--bg-1);
  color: var(--text-light);
  min-height: 100vh;
  margin: 0;
  padding: 0;
}
.container {
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
}
.card {
  background: var(--bg-2);
  border-radius: 16px;
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-2);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 20px;
}
.header {
  text-align: center;
  margin-bottom: 30px;
}
.header h1 {
  font-size: 2.5rem;
  font-weight: 700;
  color: var(--accent-2);
  margin-bottom: 5px;
  text-shadow: 0 0 10px rgba(29, 233, 182, 0.5);
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  box-shadow: var(--shadow);
  margin: 5px;
}
.btn-primary {
  background: linear-gradient(45deg, var(--accent), var(--accent-2));
  color: var(--bg-1);
}
.btn-primary:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}
.btn-secondary {
  background-color: var(--bg-3);
  color: var(--text-light);
  border: 1px solid var(--accent);
}
.btn-secondary:hover {
  background-color: var(--bg-3);
  box-shadow: 0 0 10px var(--accent);
}
.btn-danger {
  background-color: var(--danger);
  color: var(--text-light);
}
.btn-danger:hover {
  opacity: 0.9;
}
.grid-2 {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
}
@media (min-width: 600px) {
  .grid-2 {
    grid-template-columns: 1fr 1fr;
  }
}
.member-list, .expense-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.member-tag {
  background: var(--glass);
  padding: 8px 12px;
  border-radius: 8px;
  color: var(--text-light);
  font-size: 0.9rem;
  border: 1px solid var(--accent);
  display: flex;
  align-items: center;
  cursor: pointer;
}
.member-tag i {
  margin-right: 5px;
  color: var(--accent-2);
}
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.8);
  backdrop-filter: blur(5px);
  justify-content: center;
  align-items: center;
}
.modal-content {
  background: var(--bg-2);
  padding: 30px;
  border-radius: 16px;
  width: 90%;
  max-width: 500px;
  box-shadow: var(--shadow);
  position: relative;
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(-20px);}
  to {opacity: 1; transform: translateY(0);}
}
.modal-content h2 {
  color: var(--accent);
  margin-top: 0;
  border-bottom: 2px solid var(--glass-2);
  padding-bottom: 10px;
  margin-bottom: 20px;
}
.form-group {
  margin-bottom: 15px;
}
.form-group label {
  display: block;
  margin-bottom: 5px;
  color: var(--text-muted);
  font-weight: 500;
}
.form-group input, .form-group select, .form-group textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid var(--bg-3);
  background-color: var(--glass);
  color: var(--text-light);
  border-radius: 8px;
  box-sizing: border-box;
}
.close-btn {
  position: absolute;
  top: 15px;
  right: 25px;
  color: var(--text-muted);
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close-btn:hover {
  color: var(--danger);
}
/* Expense Table Styling */
.expense-table-container {
  overflow-x: auto;
}
.expense-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 0.9rem;
}
.expense-table th, .expense-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--glass);
}
.expense-table th {
  background-color: var(--bg-3);
  color: var(--accent-2);
  text-transform: uppercase;
  font-weight: 700;
}
.expense-table tbody tr:hover {
  background-color: var(--glass-2);
}
.expense-table .actions button {
  padding: 5px 10px;
  font-size: 0.8rem;
}
/* Toast Notification */
#toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
}
.toast {
  padding: 15px 20px;
  border-radius: 12px;
  margin-bottom: 10px;
  box-shadow: var(--shadow);
  color: var(--bg-1);
  font-weight: 600;
  opacity: 0;
  transition: opacity 0.5s, transform 0.5s;
  transform: translateX(100%);
  display: flex;
  align-items: center;
}
.toast.show {
  opacity: 1;
  transform: translateX(0);
}
.toast.success { background-color: var(--accent-2); }
.toast.error { background-color: var(--danger); }
.toast.warning { background-color: orange; }
.toast i { margin-right: 10px; font-size: 1.2rem; }
/* Rent Box */
.rent-box {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background-color: var(--bg-3);
  border-radius: 10px;
  margin-bottom: 20px;
  border: 1px solid var(--accent);
}
.rent-box h3 {
  margin: 0;
  font-size: 1.2rem;
  color: var(--text-light);
}
.rent-box p {
  margin: 0;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--accent);
}
/* Balances/Report Section */
.balance-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}
.balance-table th, .balance-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid var(--glass);
}
.balance-table th {
  background-color: var(--bg-3);
  color: var(--accent-2);
}
.balance-table td.positive { color: var(--accent-2); font-weight: 600; }
.balance-table td.negative { color: var(--danger); font-weight: 600; }
.report-content {
  max-height: 70vh;
  overflow-y: auto;
  padding-right: 10px;
}
.report-content h3 {
  color: var(--accent);
  margin-top: 20px;
  border-bottom: 1px dashed var(--glass);
  padding-bottom: 5px;
}
.report-content ul {
  list-style: none;
  padding: 0;
}
.report-content ul li {
  background-color: var(--glass-2);
  padding: 10px;
  border-radius: 8px;
  margin-bottom: 8px;
  border-left: 4px solid var(--accent-2);
}

.report-summary-box {
    text-align: center;
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 12px;
    background-color: var(--bg-3);
    border: 1px solid var(--accent-2);
}
.report-summary-box h4 {
    color: var(--accent-2);
    margin-top: 0;
}
.report-summary-box p {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--accent);
}

</style>
</head>
<body>

<div id="toast-container"></div>

<div class="container">
  <header class="header">
    <h1><i class="fas fa-wallet"></i> Room Expense Tracker</h1>
    <p class="text-xs text-center text-gray-400">Collaborative expense sharing (Room ID: <span id="userIdDisplay">Loading...</span>)</p>
  </header>

  <!-- Rent Box -->
  <div class="rent-box">
    <h3>Monthly Rent</h3>
    <p id="rentDisplay">$0.00</p>
    <button class="btn btn-secondary" onclick="openRentModal()"><i class="fas fa-edit"></i> Set Rent</button>
  </div>
  
  <!-- Members Card -->
  <div class="card">
    <h2><i class="fas fa-users"></i> Members</h2>
    <div id="memberList" class="member-list">
      <!-- Member tags will be rendered here -->
    </div>
    <div class="mt-4 flex justify-end">
      <button class="btn btn-primary" onclick="openMemberEditor()"><i class="fas fa-plus"></i> Add Member</button>
    </div>
  </div>

  <!-- Expenses Card -->
  <div class="card">
    <h2><i class="fas fa-list-alt"></i> Expenses</h2>
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-gray-300">Detailed List</h3>
      <button class="btn btn-primary" onclick="openAddExpenseModal()"><i class="fas fa-plus"></i> Add Expense</button>
    </div>
    <div class="expense-table-container">
      <table id="expenseTable" class="expense-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Amount ($)</th>
            <th>Paid By</th>
            <th>Split With</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="expenseTableBody">
          <!-- Expenses rows will be rendered here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Report Card -->
  <div class="card">
    <h2 class="flex justify-between items-center">
      <span><i class="fas fa-chart-bar"></i> Balances & Report</span>
      <button class="btn btn-secondary" onclick="openReportModal()"><i class="fas fa-calculator"></i> Calculate & View Report</button>
    </h2>
    <div class="report-summary-box">
        <h4>Total Shared Expenses</h4>
        <p id="totalExpensesDisplay">$0.00</p>
    </div>
    <div class="expense-table-container">
        <table id="balanceTable" class="balance-table">
            <thead>
                <tr>
                    <th>Member</th>
                    <th>Total Paid</th>
                    <th>Should Pay</th>
                    <th>Net Balance</th>
                </tr>
            </thead>
            <tbody id="balanceTableBody">
                <!-- Balances will be rendered here -->
            </tbody>
        </table>
    </div>
  </div>
</div>

<!-- Rent Modal -->
<div id="rentModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeRentModal()">&times;</span>
    <h2>Set Monthly Rent</h2>
    <div class="form-group">
      <label for="rentInput">Rent Amount ($)</label>
      <input type="number" id="rentInput" placeholder="e.g., 1200" value="0" min="0">
    </div>
    <button class="btn btn-primary w-full" onclick="saveRent()"><i class="fas fa-save"></i> Save Rent</button>
  </div>
</div>

<!-- Member Editor Modal -->
<div id="memberModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeMemberEditor()">&times;</span>
    <h2 id="memberModalTitle">Add New Member</h2>
    <input type="hidden" id="memberIdInput">
    <div class="form-group">
      <label for="memberNameInput">Member Name</label>
      <input type="text" id="memberNameInput" placeholder="e.g., Jane Doe">
    </div>
    <button class="btn btn-primary w-full" id="memberSaveBtn" onclick="saveMember()"><i class="fas fa-save"></i> Save Member</button>
    <button class="btn btn-danger w-full mt-3" id="memberDeleteBtn" onclick="deleteMember()" style="display: none;"><i class="fas fa-trash"></i> Delete Member</button>
  </div>
</div>

<!-- Expense Modal -->
<div id="expenseModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeAddExpenseModal()">&times;</span>
    <h2 id="expenseModalTitle">Add New Expense</h2>
    <input type="hidden" id="expenseIdInput">

    <div class="form-group">
      <label for="expenseDescription">Description</label>
      <input type="text" id="expenseDescription" placeholder="e.g., Groceries for the month">
    </div>
    
    <!-- DATE FIX: ADDED DATE INPUT FIELD HERE -->
    <div class="form-group">
      <label for="expenseDate">Date of Expense</label>
      <input type="date" id="expenseDate" required>
    </div>
    <!-- END DATE FIX -->

    <div class="form-group">
      <label for="expenseAmount">Amount ($)</label>
      <input type="number" id="expenseAmount" placeholder="e.g., 150" min="0">
    </div>

    <div class="form-group">
      <label for="expensePaidBy">Paid By</label>
      <select id="expensePaidBy">
        <!-- Options populated by JS -->
      </select>
    </div>

    <div class="form-group">
      <label>Split With (Select all who are sharing this expense)</label>
      <div id="expenseSplitWith" class="member-list p-2 border border-gray-700 rounded-lg">
        <!-- Checkboxes populated by JS -->
      </div>
    </div>

    <button class="btn btn-primary w-full" id="expenseSaveBtn" onclick="addExpense()"><i class="fas fa-save"></i> Save Expense</button>
  </div>
</div>

<!-- Report Modal -->
<div id="reportModal" class="modal">
  <div class="modal-content max-w-2xl">
    <span class="close-btn" onclick="closeReportModal()">&times;</span>
    <h2>Detailed Settlement Report</h2>

    <div class="report-content">
        <div class="report-summary-box">
            <h4>Total Outstanding Balance</h4>
            <p id="reportTotalOutstanding">$0.00</p>
        </div>

        <div id="settlementList">
            <!-- Settlement calculations will be rendered here -->
        </div>

        <h3 class="mt-4">Balances Overview</h3>
        <table class="balance-table">
            <thead>
                <tr><th>Member</th><th>Net Balance</th></tr>
            </thead>
            <tbody id="reportBalanceTableBody">
            </tbody>
        </table>

        <div class="mt-6 flex justify-end">
            <button class="btn btn-secondary mr-2" onclick="generatePDF()"><i class="fas fa-file-pdf"></i> Download PDF</button>
            <button class="btn btn-primary" onclick="clearAllData()"><i class="fas fa-broom"></i> Reset Room Data</button>
        </div>
    </div>
  </div>
</div>


<script type="module">
  // ----------------------------------------------------------------------------------
  // MANDATORY FIREBASE SETUP
  // This section is required for any data (including the date) to be saved persistently
  // ----------------------------------------------------------------------------------
  import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { 
    getFirestore, doc, setDoc, onSnapshot, getDoc, 
    collection, deleteDoc, runTransaction 
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // Global Firebase & App Variables
  let app;
  let db;
  let auth;
  window.db = null;
  window.auth = null;
  window.userId = null;
  
  window.roomData = {
    members: [],
    expenses: [],
    rent: 0,
    lastUpdated: new Date().toISOString()
  };

  const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

  window.initialLoadComplete = false;

  // Firestore Initialization and Authentication
  if (Object.keys(firebaseConfig).length > 0) {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);
    window.db = db;
    window.auth = auth;
    setLogLevel('Debug');
  } else {
    console.error("Firebase config is missing.");
    document.getElementById('userIdDisplay').textContent = 'ERROR';
  }

  // Handle Authentication and trigger data loading
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      window.userId = user.uid;
      document.getElementById('userIdDisplay').textContent = APP_ID; // Display the shared App ID
      loadData();
    } else {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Authentication failed:", error);
        showToast('error', 'Authentication failed. Data cannot be saved.');
        window.userId = crypto.randomUUID(); // Fallback UUID
        document.getElementById('userIdDisplay').textContent = 'AUTH ERROR';
      }
    }
  });

  // Helper to get the public document reference
  function getRoomDataRef() {
    if (!window.db || !APP_ID) {
      throw new Error("Database or App ID not initialized.");
    }
    // MANDATORY PUBLIC PATH: /artifacts/{appId}/public/data/room/roomState
    return doc(window.db, 'artifacts', APP_ID, 'public', 'data', 'room', 'roomState');
  }

  // The corrected save function
  window.saveRoomData = async function() {
    if (!window.db || !window.userId) {
      showToast('error', 'Cannot save: Database not ready or user not authenticated.');
      return;
    }
    
    try {
      const dataRef = getRoomDataRef();
      const dataToSave = {
        ...window.roomData,
        lastUpdated: new Date().toISOString()
      };

      // Use setDoc to overwrite with the current state
      await setDoc(dataRef, dataToSave, { merge: false });
      console.log("Room data successfully saved to public path.");
    } catch (e) {
      console.error("Error saving document: ", e);
      showToast('error', 'Failed to save data!');
    }
  };

  // Corrected load function using the public document path
  window.loadData = function() {
    if (!window.db || !window.userId) return;
    
    try {
        const dataRef = getRoomDataRef();
        
        onSnapshot(dataRef, (docSnapshot) => {
          if (docSnapshot.exists()) {
            const loadedData = docSnapshot.data();
            window.roomData = {
              members: loadedData.members || [],
              expenses: loadedData.expenses || [],
              rent: loadedData.rent || 0,
              lastUpdated: loadedData.lastUpdated || new Date().toISOString()
            };
            
            updateUI();
            
            if (!window.initialLoadComplete) {
                showToast('success', 'Data loaded from Firebase!');
                window.initialLoadComplete = true; 
            }
          } else {
            console.log("No initial data found, starting fresh and saving defaults.");
            window.roomData = { members: [], expenses: [], rent: 0, lastUpdated: new Date().toISOString() };
            window.saveRoomData(); // Create the initial document
            
            showToast('warning', 'Starting a new room group.');
            updateUI();
          }
        }, (error) => {
          console.error("Firestore listener failed:", error);
          showToast('error', 'Error connecting to database.');
        });
    } catch (e) {
        console.error("Error setting up data listener:", e);
        showToast('error', 'Failed to initialize data listener.');
    }
  };

  window.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
          if (window.auth.currentUser) {
              loadData();
          }
      }, 500); 
  });

  // Export functions to global scope
  window.uuidv4 = crypto.randomUUID.bind(crypto); 
  window.openRentModal = openRentModal;
  window.closeRentModal = closeRentModal;
  window.saveRent = saveRent;
  window.openMemberEditor = openMemberEditor;
  window.closeMemberEditor = closeMemberEditor;
  window.saveMember = saveMember;
  window.deleteMember = deleteMember;
  window.openAddExpenseModal = openAddExpenseModal;
  window.closeAddExpenseModal = closeAddExpenseModal;
  window.addExpense = addExpense;
  window.editExpense = editExpense;
  window.deleteExpense = deleteExpense;
  window.openReportModal = openReportModal;
  window.closeReportModal = closeReportModal;
  window.generatePDF = generatePDF;
  window.clearAllData = clearAllData;
  window.updateMemberUI = updateMemberUI;
  window.updateExpenseTable = updateExpenseTable;
  window.updateRentBox = updateRentBox;
  window.showToast = showToast;
  window.updateUI = updateUI;
  window.scrollToTop = scrollToTop;
</script>


<script>
// Global UI and Utility Functions (outside of module script)

// --- Toasts ---
function showToast(type, message) {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  let icon = '';
  if (type === 'success') icon = '<i class="fas fa-check-circle"></i>';
  else if (type === 'error') icon = '<i class="fas fa-exclamation-triangle"></i>';
  else if (type === 'warning') icon = '<i class="fas fa-bell"></i>';
  
  toast.innerHTML = `${icon} ${message}`;
  container.appendChild(toast);

  // Show
  setTimeout(() => toast.classList.add('show'), 10);

  // Hide after 4 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    // Remove from DOM after transition
    setTimeout(() => toast.remove(), 500);
  }, 4000);
}

// --- Rent Functions ---
function openRentModal() {
  document.getElementById('rentInput').value = window.roomData.rent;
  document.getElementById('rentModal').style.display = 'flex';
}

function closeRentModal() {
  document.getElementById('rentModal').style.display = 'none';
}

function saveRent() {
  const rentAmount = parseFloat(document.getElementById('rentInput').value) || 0;
  if (rentAmount < 0) {
    showToast('error', 'Rent must be a positive number.');
    return;
  }
  window.roomData.rent = rentAmount;
  window.saveRoomData(); // Persist the change
  closeRentModal();
}

function updateRentBox() {
  document.getElementById('rentDisplay').textContent = `$${window.roomData.rent.toFixed(2)}`;
}


// --- Member Functions ---
function openMemberEditor(member = null) {
  const modal = document.getElementById('memberModal');
  const title = document.getElementById('memberModalTitle');
  const nameInput = document.getElementById('memberNameInput');
  const idInput = document.getElementById('memberIdInput');
  const saveBtn = document.getElementById('memberSaveBtn');
  const deleteBtn = document.getElementById('memberDeleteBtn');

  if (member) {
    title.textContent = 'Edit Member';
    nameInput.value = member.name;
    idInput.value = member.id;
    deleteBtn.style.display = 'block';
  } else {
    title.textContent = 'Add New Member';
    nameInput.value = '';
    idInput.value = '';
    deleteBtn.style.display = 'none';
  }
  modal.style.display = 'flex';
}

function closeMemberEditor() {
  document.getElementById('memberModal').style.display = 'none';
}

function saveMember() {
  const name = document.getElementById('memberNameInput').value.trim();
  const id = document.getElementById('memberIdInput').value;

  if (!name) {
    showToast('error', 'Member name cannot be empty.');
    return;
  }

  if (id) {
    // Edit existing member
    const index = window.roomData.members.findIndex(m => m.id === id);
    if (index !== -1) {
      window.roomData.members[index].name = name;
      showToast('success', `Member ${name} updated!`);
    }
  } else {
    // Add new member
    if (window.roomData.members.some(m => m.name.toLowerCase() === name.toLowerCase())) {
        showToast('error', 'A member with this name already exists.');
        return;
    }
    const newMember = { id: window.uuidv4(), name: name };
    window.roomData.members.push(newMember);
    showToast('success', `Member ${name} added!`);
  }

  window.saveRoomData(); // Persist the change
  closeMemberEditor();
}

function deleteMember() {
  const memberId = document.getElementById('memberIdInput').value;
  const memberName = document.getElementById('memberNameInput').value;
  
  // Custom confirmation dialog replacement
  const isConfirmed = confirm('Are you sure you want to delete this member? All associated expenses will remain.');
  
  if (isConfirmed) {
      window.roomData.members = window.roomData.members.filter(m => m.id !== memberId);
      // Remove member from any existing expense splits where they might be included
      window.roomData.expenses.forEach(expense => {
          expense.splitWith = expense.splitWith.filter(id => id !== memberId);
          // If the deleted member was the one who paid, the expense needs attention
          if (expense.paidBy === memberId) {
              showToast('warning', `Member ${memberName} paid for an expense. Review or update Expense: ${expense.description}`);
              // Optionally: set paidBy to null or the first remaining member
          }
      });
      
      window.saveRoomData(); // Persist the change
      showToast('success', `Member ${memberName} deleted.`);
      closeMemberEditor();
  }
}

function updateMemberUI() {
  const list = document.getElementById('memberList');
  const paidBySelect = document.getElementById('expensePaidBy');
  const splitWithDiv = document.getElementById('expenseSplitWith');

  list.innerHTML = '';
  paidBySelect.innerHTML = '<option value="">-- Select Payer --</option>';
  splitWithDiv.innerHTML = '';

  window.roomData.members.forEach(member => {
    // Member Tag in main UI
    const tag = document.createElement('div');
    tag.className = 'member-tag';
    tag.innerHTML = `<i class="fas fa-user-circle"></i> ${member.name}`;
    tag.onclick = () => openMemberEditor(member);
    list.appendChild(tag);

    // Paid By dropdown option
    const option = document.createElement('option');
    option.value = member.id;
    option.textContent = member.name;
    paidBySelect.appendChild(option);

    // Split With checkbox in expense modal
    const checkboxWrapper = document.createElement('div');
    checkboxWrapper.className = 'flex items-center mr-4 mb-2';
    checkboxWrapper.innerHTML = `
      <input type="checkbox" id="split-${member.id}" name="splitWith" value="${member.id}" class="h-4 w-4 text-accent-2 bg-gray-600 border-gray-500 rounded focus:ring-accent-2">
      <label for="split-${member.id}" class="ml-2 text-sm text-text-light cursor-pointer">${member.name}</label>
    `;
    splitWithDiv.appendChild(checkboxWrapper);
  });
}


// --- Expense Functions ---
function openAddExpenseModal(expense = null) {
  const modal = document.getElementById('expenseModal');
  const title = document.getElementById('expenseModalTitle');
  const idInput = document.getElementById('expenseIdInput');
  const descInput = document.getElementById('expenseDescription');
  const dateInput = document.getElementById('expenseDate'); // <-- DATE FIX: Get date input element
  const amountInput = document.getElementById('expenseAmount');
  const paidBySelect = document.getElementById('expensePaidBy');
  const splitCheckboxes = document.querySelectorAll('#expenseSplitWith input[type="checkbox"]');
  const saveBtn = document.getElementById('expenseSaveBtn');

  const today = new Date().toISOString().substring(0, 10);

  // Reset all
  descInput.value = '';
  amountInput.value = '';
  paidBySelect.value = '';
  idInput.value = '';
  dateInput.value = today; // <-- DATE FIX: Set default date to today
  splitCheckboxes.forEach(cb => cb.checked = false);

  if (expense) {
    title.textContent = 'Edit Expense';
    idInput.value = expense.id;
    descInput.value = expense.description;
    dateInput.value = expense.date; // <-- DATE FIX: Load existing date
    amountInput.value = expense.amount;
    paidBySelect.value = expense.paidBy;

    // Set split with checkboxes
    expense.splitWith.forEach(memberId => {
      const checkbox = document.getElementById(`split-${memberId}`);
      if (checkbox) checkbox.checked = true;
    });
    saveBtn.textContent = 'Save Changes';
  } else {
    title.textContent = 'Add New Expense';
    saveBtn.textContent = 'Save Expense';
    // Default split: all members
    document.getElementById('expenseSplitWith').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
  }

  modal.style.display = 'flex';
}

function closeAddExpenseModal() {
  document.getElementById('expenseModal').style.display = 'none';
}

function addExpense() {
  const id = document.getElementById('expenseIdInput').value;
  const description = document.getElementById('expenseDescription').value.trim();
  const date = document.getElementById('expenseDate').value; // <-- DATE FIX: Get the date value
  const amount = parseFloat(document.getElementById('expenseAmount').value);
  const paidBy = document.getElementById('expensePaidBy').value;
  const splitWith = Array.from(document.querySelectorAll('#expenseSplitWith input[type="checkbox"]:checked')).map(cb => cb.value);

  // DATE FIX: Added date validation
  if (!description || !date || !amount || amount <= 0 || !paidBy || splitWith.length === 0) {
    showToast('error', 'Please fill all fields (including date), ensure amount is positive, and select at least one person to split with.');
    return;
  }

  const newExpense = {
    id: id || window.uuidv4(),
    description,
    amount,
    paidBy,
    splitWith,
    date: date // <-- DATE FIX: Save the date from the input
  };

  if (id) {
    // Edit existing
    const index = window.roomData.expenses.findIndex(e => e.id === id);
    if (index !== -1) {
      window.roomData.expenses[index] = newExpense;
      showToast('success', 'Expense updated!');
    }
  } else {
    // Add new
    window.roomData.expenses.push(newExpense);
    showToast('success', 'Expense added!');
  }

  window.saveRoomData(); // Persist the change
  closeAddExpenseModal();
}

function editExpense(expenseId) {
  const expense = window.roomData.expenses.find(e => e.id === expenseId);
  if (expense) {
    openAddExpenseModal(expense);
  }
}

function deleteExpense(expenseId) {
  // Custom confirmation dialog replacement
  const isConfirmed = confirm('Are you sure you want to delete this expense?');

  if (isConfirmed) {
    window.roomData.expenses = window.roomData.expenses.filter(e => e.id !== expenseId);
    window.saveRoomData(); // Persist the change
    showToast('success', 'Expense deleted!');
  }
}

function updateExpenseTable() {
  const tbody = document.getElementById('expenseTableBody');
  tbody.innerHTML = '';
  
  let totalExpenses = window.roomData.rent;
  
  // Sort expenses by date descending
  const sortedExpenses = [...window.roomData.expenses].sort((a, b) => new Date(b.date) - new Date(a.date));

  sortedExpenses.forEach(expense => {
    totalExpenses += expense.amount;
    const paidByName = window.roomData.members.find(m => m.id === expense.paidBy)?.name || 'Unknown';
    const splitWithNames = expense.splitWith.map(id => window.roomData.members.find(m => m.id === id)?.name || '?').join(', ');
    
    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${expense.date}</td> <!-- <-- DATE FIX: Date display confirmed -->
      <td>${expense.description}</td>
      <td>$${expense.amount.toFixed(2)}</td>
      <td>${paidByName}</td>
      <td>${splitWithNames}</td>
      <td class="actions">
        <button class="btn btn-secondary" onclick="editExpense('${expense.id}')"><i class="fas fa-edit"></i></button>
        <button class="btn btn-danger" onclick="deleteExpense('${expense.id}')"><i class="fas fa-trash"></i></button>
      </td>
    `;
  });
  
  document.getElementById('totalExpensesDisplay').textContent = `$${totalExpenses.toFixed(2)}`;
  updateBalanceTable(); // Update balances whenever expenses change
}


// --- Report/Balance Functions ---

function calculateBalances() {
  const { members, expenses, rent } = window.roomData;
  const balances = members.reduce((acc, m) => {
    acc[m.id] = {
      name: m.name,
      paid: 0,
      shouldPay: 0,
      netBalance: 0,
      expensesPaid: 0,
      rentShare: 0
    };
    return acc;
  }, {});

  // 1. Calculate Rent Share
  const totalMembers = members.length;
  if (totalMembers > 0 && rent > 0) {
      const rentPerMember = rent / totalMembers;
      members.forEach(m => {
          balances[m.id].shouldPay += rentPerMember;
          balances[m.id].rentShare = rentPerMember;
      });
  }
  
  // 2. Calculate Expense Balances
  expenses.forEach(e => {
    const splitCount = e.splitWith.length;
    if (splitCount === 0) return;

    const share = e.amount / splitCount;
    
    // Add to paid amount for the payer
    balances[e.paidBy].paid += e.amount;
    balances[e.paidBy].expensesPaid += e.amount;

    // Add to shouldPay for all members in the split
    e.splitWith.forEach(memberId => {
      balances[memberId].shouldPay += share;
    });
  });

  // 3. Calculate Net Balance
  Object.values(balances).forEach(b => {
    // Net Balance is what they Paid minus what they Should Pay
    b.netBalance = b.paid - b.shouldPay;
  });

  return balances;
}

function updateBalanceTable(isReport = false) {
  const balances = calculateBalances();
  const tbody = isReport ? document.getElementById('reportBalanceTableBody') : document.getElementById('balanceTableBody');
  tbody.innerHTML = '';

  Object.values(balances).sort((a, b) => b.netBalance - a.netBalance).forEach(b => {
    const balanceClass = b.netBalance >= 0 ? 'positive' : 'negative';
    const balanceText = b.netBalance >= 0 ? `$${b.netBalance.toFixed(2)} (Owes you)` : `$${(b.netBalance * -1).toFixed(2)} (You owe)`;

    const row = tbody.insertRow();
    row.innerHTML = `
      <td>${b.name}</td>
      ${isReport ? '' : `
        <td>$${b.paid.toFixed(2)}</td>
        <td>$${b.shouldPay.toFixed(2)}</td>
      `}
      <td class="${balanceClass}">${balanceText}</td>
    `;
  });

  return balances;
}

function calculateSettlements(balances) {
  let payers = Object.values(balances).filter(b => b.netBalance > 0);
  let receivers = Object.values(balances).filter(b => b.netBalance < 0);
  let settlements = [];
  let totalOutstanding = 0;

  payers.sort((a, b) => b.netBalance - a.netBalance); // Highest payer first
  receivers.sort((a, b) => a.netBalance - b.netBalance); // Lowest receiver (highest debt) first

  let pIndex = 0;
  let rIndex = 0;

  while (pIndex < payers.length && rIndex < receivers.length) {
    let payer = payers[pIndex];
    let receiver = receivers[rIndex];
    
    // Note: receiver's netBalance is negative, so use Math.abs()
    let amountToSettle = Math.min(payer.netBalance, Math.abs(receiver.netBalance));

    if (amountToSettle > 0.01) { // Check for a non-negligible amount
      settlements.push({
        from: receiver.name,
        to: payer.name,
        amount: amountToSettle
      });

      payer.netBalance -= amountToSettle;
      receiver.netBalance += amountToSettle; // Adds back the negative amount

      totalOutstanding += amountToSettle;
    }
    
    // Move pointers
    if (payer.netBalance < 0.01) {
      pIndex++; // Payer is done paying
    }
    if (receiver.netBalance > -0.01) {
      rIndex++; // Receiver is done receiving
    }
  }
  
  // Update total outstanding display
  document.getElementById('reportTotalOutstanding').textContent = `$${totalOutstanding.toFixed(2)}`;

  return settlements;
}

function openReportModal() {
  const balances = updateBalanceTable(true); // Update report table
  const settlements = calculateSettlements(balances);
  
  const listDiv = document.getElementById('settlementList');
  listDiv.innerHTML = '<h3>Recommended Settlements</h3>';

  if (settlements.length === 0) {
    listDiv.innerHTML += '<p class="text-center text-text-muted mt-4">All balances are settled or zero. Good job!</p>';
  } else {
    const ul = document.createElement('ul');
    settlements.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${s.from}</strong> owes <strong>${s.to}</strong>: <span class="text-xl font-bold text-accent">$${s.amount.toFixed(2)}</span>`;
      ul.appendChild(li);
    });
    listDiv.appendChild(ul);
  }
  
  document.getElementById('reportModal').style.display = 'flex';
}

function closeReportModal() {
  document.getElementById('reportModal').style.display = 'none';
}


// --- Data Management ---
function clearAllData() {
  // Custom confirmation dialog replacement
  const isConfirmed = confirm('WARNING: This will delete ALL room data (Expenses, Members, Rent) for everyone in this group. Are you sure?');

  if (isConfirmed) {
    window.roomData = { members: [], expenses: [], rent: 0, lastUpdated: new Date().toISOString() };
    window.saveRoomData(); // Save the empty state
    showToast('success', 'Room data has been reset.');
    closeReportModal();
  }
}

// --- PDF Generation (Basic example using jspdf-autotable) ---
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  doc.text("Room Expense Tracker Settlement Report", 14, 20);
  doc.setFontSize(10);
  doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 14, 26);
  doc.text(`Room ID: ${APP_ID}`, 14, 32);
  doc.setFontSize(12);

  const balances = calculateBalances();
  const settlements = calculateSettlements(balances);
  const totalOutstanding = document.getElementById('reportTotalOutstanding').textContent;

  // 1. Balances Table
  let balanceData = Object.values(balances).map(b => [
    b.name,
    `$${b.paid.toFixed(2)}`,
    `$${b.shouldPay.toFixed(2)}`,
    b.netBalance >= 0 ? `$${b.netBalance.toFixed(2)}` : `-$${(b.netBalance * -1).toFixed(2)}`
  ]);

  doc.autoTable({
    startY: 40,
    head: [['Member', 'Total Paid', 'Should Pay', 'Net Balance']],
    body: balanceData,
    theme: 'striped',
    headStyles: { fillColor: [44, 83, 100], textColor: [255, 255, 255] }
  });

  let finalY = doc.lastAutoTable.finalY + 10;
  
  // 2. Summary
  doc.setFontSize(12);
  doc.text(`Total Shared Expenses (Incl. Rent): ${document.getElementById('totalExpensesDisplay').textContent}`, 14, finalY);
  finalY += 7;
  doc.setFontSize(14);
  doc.setTextColor(0, 198, 255);
  doc.text(`Total Outstanding to Settle: ${totalOutstanding}`, 14, finalY);
  doc.setTextColor(0, 0, 0);
  finalY += 10;

  // 3. Settlements List
  doc.setFontSize(12);
  doc.text("Recommended Settlements", 14, finalY);
  finalY += 7;

  let settlementData = settlements.map(s => [
    s.from,
    s.to,
    `$${s.amount.toFixed(2)}`
  ]);

  if (settlementData.length > 0) {
    doc.autoTable({
      startY: finalY,
      head: [['Owes', 'Pays To', 'Amount']],
      body: settlementData,
      theme: 'grid',
      headStyles: { fillColor: [0, 198, 255], textColor: [255, 255, 255] }
    });
  } else {
    doc.text("All balances are settled. No transfers needed.", 14, finalY);
  }


  doc.save('RoomExpenseReport.pdf');
  showToast('success', 'PDF report generated!');
}

/* update UI pieces */
function updateUI() {
  updateExpenseTable();
  updateMemberUI();
  updateRentBox();
}

/* helpers */
function scrollToTop(){ window.scrollTo({top:0,behavior:'smooth'}); }

/* small enhancement: close modal on backdrop click */
document.querySelectorAll('.modal').forEach(mod => {
  mod.addEventListener('click', (e) => {
    if (e.target === mod) {
      // Check which modal is open and call its specific close function
      if (mod.id === 'expenseModal') closeAddExpenseModal();
      else if (mod.id === 'memberModal') closeMemberEditor();
      else if (mod.id === 'reportModal') closeReportModal();
      else if (mod.id === 'rentModal') closeRentModal();
    }
  });
});
</script>

</body>
</html>
